<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
    
  Flutter 自定义布局实战 - MagicalRice的Blog
  
  </title>
  
  
  <link href="atom.xml" rel="alternate" title="MagicalRice的Blog" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />
    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
 
<script type="text/javascript">
  function before_search(){
    var searchVal = 'site:adolph.cc ' + document.getElementById('search_input').value;
    document.getElementById('search_q').value = searchVal;
    return true;
  }
</script>
  </head>
  <body class="antialiased hide-extras">
    
    <div class="marketing off-canvas-wrap" data-offcanvas>
      <div class="inner-wrap">


<nav class="top-bar docs-bar hide-for-small" data-topbar>


  <section class="top-bar-section">
  <div class="row">
      <div style="position: relative;width:100%;"><div style="position: absolute; width:100%;">
        <ul id="main-menu" class="left">
        
        <li id=""><a target="_self" href="index.html">Home</a></li>
        
        <li id=""><a target="_self" href="archives.html">Archives</a></li>
        
        </ul>

        <ul class="right" id="search-wrap">
          <li>
<form target="_blank" onsubmit="return before_search();" action="https://google.com/search" method="get">
    <input type="hidden" id="search_q" name="q" value="" />
    <input tabindex="1" type="search" id="search_input"  placeholder="Search"/>
</form>
</li>
          </ul>
      </div></div>
  </div>
  </section>

</nav>

        <nav class="tab-bar show-for-small">
  <a href="javascript:void(0)" class="left-off-canvas-toggle menu-icon">
    <span> &nbsp; MagicalRice的Blog</span>
  </a>
</nav>

<aside class="left-off-canvas-menu">
      <ul class="off-canvas-list">
        
        <li><a target="_self" href="index.html">Home</a></li>
        
        <li><a target="_self" href="archives.html">Archives</a></li>
        

    <li><label>Categories</label></li>

        
            <li><a href="Android.html">Android</a></li>
        
            <li><a href="%E6%9C%8D%E5%8A%A1%E5%99%A8.html">服务器</a></li>
        
            <li><a href="C++.html">C++</a></li>
        
            <li><a href="UI.html">UI</a></li>
        
            <li><a href="%E4%BB%A3%E7%A0%81%E4%B9%8B%E7%BE%8E.html">代码之美</a></li>
        
            <li><a href="Game.html">Game</a></li>
        
            <li><a href="Python.html">Python</a></li>
        
            <li><a href="Mac.html">Mac</a></li>
        
            <li><a href="%E5%85%B6%E4%BB%96.html">其他</a></li>
        
            <li><a href="Flutter.html">Flutter</a></li>
        
            <li><a href="ReactNative.html">ReactNative</a></li>
        
            <li><a href="Java.html">Java</a></li>
        
            <li><a href="%E9%9F%B3%E8%A7%86%E9%A2%91%E5%BC%80%E5%8F%91.html">音视频开发</a></li>
        
            <li><a href="%E7%BD%91%E7%BB%9C.html">网络</a></li>
        
            <li><a href="%E7%BD%91%E9%A1%B5.html">网页</a></li>
        
            <li><a href="%E5%B7%A5%E5%85%B7-1-2.html">工具</a></li>
        
            <li><a href="%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD.html">人工智能</a></li>
        
            <li><a href="%E5%88%9B%E4%B8%9A.html">创业</a></li>
        
            <li><a href="%E6%80%9D%E7%BB%B4%E6%8F%90%E5%8D%87.html">思维提升</a></li>
        
            <li><a href="GPU%E6%B8%B2%E6%9F%93.html">GPU渲染</a></li>
         

      </ul>
    </aside>

<a class="exit-off-canvas" href="#"></a>


        <section id="main-content" role="main" class="scroll-container">
        
       

 <script type="text/javascript">
  $(function(){
    $('#menu_item_index').addClass('is_active');
  });
</script>
<div class="row">
  <div class="large-8 medium-8 columns">
      <div class="markdown-body article-wrap">
       <div class="article">
          
          <h1>Flutter 自定义布局实战</h1>
     
        <div class="read-more clearfix">
          <span class="date">2023/06/29</span>

          <span>posted in&nbsp;</span> 
          
              <span class="posted-in"><a href='%E7%BB%84%E4%BB%B6%E5%BA%93.html'>组件库</a></span>
           
         
          <span class="comments">
            

            
          </span>

        </div>
      </div><!-- article -->

      <div class="article-content">
      <p>本篇将解析 Flutter 中自定义布局的原理，并带你深入实战自定义布局的流程，利用两种自定义布局的实现方式，完成如下图所示的界面效果，看完这一篇你将可以更轻松的对 Flutter 为所欲为。</p>
<p><img src="media/16880177694288/16880178429289.jpg" alt="" /></p>
<span id="more"></span><!-- more -->
<h2><a id="%E5%89%8D%E8%A8%80" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>前言</h2>
<p>我们应该都了解过 <code>Widget</code> 、<code>Element</code> 和 <code>RenderObject</code> 之间的关系，所谓的 自定义布局，<strong>事实上就是自定义 RenderObject 内 child 的大小和位置</strong> ，而在这点上和其他框架不同的是，在 Flutter 中布局的核心并不是嵌套堆叠，<strong>Flutter 布局的核心是在于 Canvas</strong> ，我们所使用的 Widget ，仅仅是为了简化  RenderObject 的操作。</p>
<blockquote>
<p>对于 Flutter 而言，整个屏幕都是一块画布，我们通过各种 <code>Offset</code> 和 <code>Rect</code> 确定了位置，然后通过 <code>Canvas</code> 绘制 <code>UI</code>，而整个屏幕区域都是绘制目标，如果在 <code>child</code> 中我们 “不按照套路出牌” ，我们甚至可以不管 <code>parent</code> 的大小和位置随意绘制。</p>
</blockquote>
<h2><a id="multichildrenderobjectwidget" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>MultiChildRenderObjectWidget</h2>
<p>了解基本概念后，我们知道 <strong>自定义 <code>Widget</code> 布局的核心在于自定义 <code>RenderObject</code></strong> ，而在官方默认提供的布局控件里，大部分的布局控件都是通过继承 <code>MultiChildRenderObjectWidget</code> 实现，那么一般情况下自定义布局时，我们需要做什么呢？</p>
<p><img src="media/16880177694288/16880179533034.jpg" alt="" /></p>
<p>如上图所示，一般情况下实现自定义布局，我们会通过继承 <code>MultiChildRenderObjectWidget</code> 和 <code>RenderBox</code> 这两个 <code>abstract</code> 类实现，而 <code>MultiChildRenderObjectElement</code> 则负责关联起它们， 除了此之外，还有有几个关键的类： <code>ContainerRenderObjectMixin</code> 、 <code>RenderBoxContainerDefaultsMixin</code> 和  <code>ContainerBoxParentData</code> 。</p>
<p><code>RenderBox</code> 我们知道是 <code>RenderObject</code> 的子类封装，也是我们自定义 <code>RenderObject</code> 时经常需要继承的，那么其他的类分别是什么含义呢？</p>
<h3><a id="containerrenderobjectmixin" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>ContainerRenderObjectMixin</h3>
<p>故名思义，这是一个 <code>mixin</code> 类，<code>ContainerRenderObjectMixin</code> 的作用，主要是维护提供了一个双链表的children <code>RenderObject</code> 。<br />
通过在 <code>RenderBox</code> 里混入 <code>ContainerRenderObjectMixin</code>， 我们就可以得到一个双链表的 <code>children</code>，方便在我们布局时，可以正向或者反向去获取和管理 <code>RenderObject</code> 们 。</p>
<h3><a id="renderboxcontainerdefaultsmixin" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>RenderBoxContainerDefaultsMixin</h3>
<p><code>RenderBoxContainerDefaultsMixin</code> 主要是对 <code>ContainerRenderObjectMixin</code> 的拓展，是对 <code>ContainerRenderObjectMixin</code>内的 <code>children</code> 提供常用的默认行为和管理，接口如下所示：</p>
<pre><code class="language-plain_text">	/// 计算返回第一个 child 的基线 ，常用于 child 的位置顺序有关
	double defaultComputeDistanceToFirstActualBaseline(TextBaseline baseline)
	
	/// 计算返回所有 child 中最小的基线，常用于 child 的位置顺序无关
	double defaultComputeDistanceToHighestActualBaseline(TextBaseline baseline)
	
	/// 触摸碰撞测试
	bool defaultHitTestChildren(BoxHitTestResult result, { Offset position })
	
	/// 默认绘制
	void defaultPaint(PaintingContext context, Offset offset)
	
	/// 以数组方式返回 child 链表
	List&lt;ChildType&gt; getChildrenAsList()
</code></pre>
<h3><a id="containerboxparentdata" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>ContainerBoxParentData</h3>
<p><code>ContainerBoxParentData</code> 是 <code>BoxParentData</code> 的子类，主要是关联了 <code>ContainerDefaultsMixin</code> 和 <code>BoxParentData</code> ，<code>BoxParentData</code> 是 <code>RenderBox</code> 绘制时所需的位置类。</p>
<p>通过 <code>ContainerBoxParentData</code>，我们可以将 <code>RenderBox</code> 需要的 <code>BoxParentData</code> 和上面的 <code>ContainerParentDataMixin</code> 组合起来，事实上我们得到的 <code>children</code> 双链表就是以 <code>ParentData</code> 的形式呈现出来的。</p>
<pre><code class="language-plain_text">abstract class ContainerBoxParentData&lt;ChildType extends RenderObject&gt; extends BoxParentData with ContainerParentDataMixin&lt;ChildType&gt; { }
</code></pre>
<h3><a id="multichildrenderobjectwidget" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>MultiChildRenderObjectWidget</h3>
<p><code>MultiChildRenderObjectWidget</code> 的实现很简单 ，它仅仅只是继承了 <code>RenderObjectWidget</code>，然后提供了 <code>children</code> 数组，并创建了 <code>MultiChildRenderObjectElement</code>。</p>
<blockquote>
<p>上面的 <code>RenderObjectWidget</code> 顾名思义，它是提供 <code>RenderObject</code> 的 <code>Widget</code> ，那有不存在<code>RenderObject</code> 的 <code>Widget</code> 吗？<br />
有的，比如我们常见的 <code>StatefulWidget</code> 、 <code>StatelessWidget</code> 、 <code>Container</code> 等，它们的 <code>Element</code> 都是 <code>ComponentElement</code> ， <code>ComponentElement</code> 仅仅起到容器的作用，而它的 <code>get renderObject</code> 需要来自它的 <code>child</code> 。</p>
</blockquote>
<h3><a id="multichildrenderobjectelement" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>MultiChildRenderObjectElement</h3>
<p>前面的篇章我们说过 <code>Element</code> 是 <code>BuildContext</code> 的实现， 内部一般持有 <code>Widget</code> 、<code>RenderObject</code> 并作为二者沟通的桥梁，那么 <code>MultiChildRenderObjectElement</code> 就是我们自定义布局时的桥梁了， 如下代码所示，<code>MultiChildRenderObjectElement</code> 主要实现了如下接口，其主要功能是对内部 <code>children</code> 的 <code>RenderObject</code> ，实现了插入、移除、访问、更新等逻辑：</p>
<pre><code class="language-dart">	/// 下面三个方法都是利用 ContainerRenderObjectMixin 的 insert/move/remove 去操作
	/// ContainerRenderObjectMixin&lt;RenderObject, ContainerParentDataMixin&lt;RenderObject&gt; 
	void insertChildRenderObject(RenderObject child, Element slot) 
	void moveChildRenderObject(RenderObject child, dynamic slot)         
	void removeChildRenderObject(RenderObject child)
	
	/// visitChildren 是通过 Element 中的 ElementVisitor 去迭代的
	/// 一般在 RenderObject get renderObject 会调用
	void visitChildren(ElementVisitor visitor)
	
	/// 添加忽略child _forgottenChildren.add(child);
	void forgetChild(Element child) 
	
	/// 通过 inflateWidget ， 把 children 中 List&lt;Widget&gt; 对应的 List&lt;Element&gt;
	void mount(Element parent, dynamic newSlot)
	
	/// 通过 updateChildren 方法去更新得到  List&lt;Element&gt;
	void update(MultiChildRenderObjectWidget newWidget)
</code></pre>
<p>所以 <code>MultiChildRenderObjectElement</code> 利用 <code>ContainerRenderObjectMixin</code> 最终将我们自定义的 <code>RenderBox</code> 和 <code>Widget</code> 关联起来。</p>
<h3><a id="%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B5%81%E7%A8%8B" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>自定义流程</h3>
<p><strong>上述主要描述了  <code>MultiChildRenderObjectWidget</code> 、 <code>MultiChildRenderObjectElement</code> 和其他三个辅助类<code>ContainerRenderObjectMixin</code> 、 <code>RenderBoxContainerDefaultsMixin</code> 和  <code>ContainerBoxParentData</code> 之间的关系。</strong></p>
<p>了解几个关键类之后，我们看一般情况下，实现自定义布局的简化流程是：</p>
<ol>
<li>自定义 <code>ParentData</code> 继承 <code>ContainerBoxParentData</code> 。</li>
<li>继承 <code>RenderBox</code> ，同时混入 <code>ContainerRenderObjectMixin</code> 和 <code>RenderBoxContainerDefaultsMixin</code> 实现自定义<code>RenderObject</code> 。</li>
<li>继承 <code>MultiChildRenderObjectWidget</code>，实现 <code>createRenderObject</code> 和 <code>updateRenderObject</code> 方法，关联我们自定义的 <code>RenderBox</code>。</li>
<li>重写 <code>RenderBox</code> 的 <code>performLayout</code> 和 <code>setupParentData</code> 方法，实现自定义布局。</li>
</ol>
<p><strong>当然我们可以利用官方的 <code>CustomMultiChildLayout</code> 实现自定义布局</strong>，这个后面也会讲到，现在让我们先从基础开始， 而上述流程中混入的 <code>ContainerRenderObjectMixin</code> 和 <code>RenderBoxContainerDefaultsMixin</code> ，在 <code>RenderFlex</code> 、<code>RenderWrap</code> 、<code>RenderStack</code> 等官方实现的布局里，也都会混入它们。</p>
<h2><a id="%E8%87%AA%E5%AE%9A%E4%B9%89%E5%B8%83%E5%B1%80" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>自定义布局</h2>
<p><strong>自定义布局就是在 <code>performLayout</code> 中实现的 <code>child.layout</code> 大小和 <code>child.ParentData.offset</code> 位置的赋值。</strong></p>
<p><img src="media/16880177694288/16880183364154.jpg" alt="" /></p>
<p>首先我们要实现类似如图效果，我们需要自定义 <code>RenderCloudParentData</code> 继承 <code>ContainerBoxParentData</code> ，用于记录宽高和内容区域 ：</p>
<pre><code class="language-dart">class RenderCloudParentData extends ContainerBoxParentData&lt;RenderBox&gt; {
  double width;
  double height;

  Rect get content =&gt; Rect.fromLTWH(
        offset.dx,
        offset.dy,
        width,
        height,
      );
}
</code></pre>
<p>然后自定义 <code>RenderCloudWidget</code> 继承 <code>RenderBox</code> ，并混入 <code>ContainerRenderObjectMixin</code> 和 <code>RenderBoxContainerDefaultsMixin</code>  实现 <code>RenderBox</code> 自定义的简化。</p>
<pre><code class="language-dart">class RenderCloudWidget extends RenderBox
    with
        ContainerRenderObjectMixin&lt;RenderBox, RenderCloudParentData&gt;,
        RenderBoxContainerDefaultsMixin&lt;RenderBox, RenderCloudParentData&gt; {
  RenderCloudWidget({
    List&lt;RenderBox&gt; children,
    Overflow overflow = Overflow.visible,
    double ratio,
  })  : _ratio = ratio,
        _overflow = overflow {
   ///添加所有 child 
    addAll(children);
  }
</code></pre>
<p>如下代码所示，接下来主要看 <code>RenderCloudWidget</code> 中 <code>performLayout</code> 中的实现，这里我们只放关键代码：</p>
<ol>
<li>我们首先拿到 <code>ContainerRenderObjectMixin</code> 链表中的  <code>firstChild</code> ，然后从头到位读取整个链表。</li>
<li>对于每个 <code>child</code> 首先通过 <code>child.layout</code> 设置他们的大小，然后记录下大小之后。</li>
<li>以容器控件的中心为起点，从内到外设置布局，这是设置的时候，需要通过记录的 <code>Rect</code> 判断是否会重复，每次布局都需要计算位置，直到当前 <code>child</code> 不在重复区域内。</li>
<li>得到最终布局内大小，然后设置整体居中。</li>
</ol>
<pre><code class="language-dart">///设置为我们的数据
@override
void setupParentData(RenderBox child) {
  if (child.parentData is! RenderCloudParentData)
    child.parentData = RenderCloudParentData();
}

@override
  void performLayout() {
    ///默认不需要裁剪
    _needClip = false;

    ///没有 childCount 不玩
    if (childCount == 0) {
      size = constraints.smallest;
      return;
    }

    ///初始化区域
    var recordRect = Rect.zero;
    var previousChildRect = Rect.zero;

    RenderBox child = firstChild;

    while (child != null) {
      var curIndex = -1;

      ///提出数据
      final RenderCloudParentData childParentData = child.parentData;

      child.layout(constraints, parentUsesSize: true);

      var childSize = child.size;

      ///记录大小
      childParentData.width = childSize.width;
      childParentData.height = childSize.height;

      do {
        ///设置 xy 轴的比例
        var rX = ratio &gt;= 1 ? ratio : 1.0;
        var rY = ratio &lt;= 1 ? ratio : 1.0;

        ///调整位置
        var step = 0.02 * _mathPi;
        var rotation = 0.0;
        var angle = curIndex * step;
        var angleRadius = 5 + 5 * angle;
        var x = rX * angleRadius * math.cos(angle + rotation);
        var y = rY * angleRadius * math.sin(angle + rotation);
        var position = Offset(x, y);

        ///计算得到绝对偏移
        var childOffset = position - Alignment.center.alongSize(childSize);

        ++curIndex;

        ///设置为遏制
        childParentData.offset = childOffset;

        ///判处是否交叠
      } while (overlaps(childParentData));

      ///记录区域
      previousChildRect = childParentData.content;
      recordRect = recordRect.expandToInclude(previousChildRect);

      ///下一个
      child = childParentData.nextSibling;
    }

    ///调整布局大小
    size = constraints
        .tighten(
          height: recordRect.height,
          width: recordRect.width,
        )
        .smallest;

    ///居中
    var contentCenter = size.center(Offset.zero);
    var recordRectCenter = recordRect.center;
    var transCenter = contentCenter - recordRectCenter;
    child = firstChild;
    while (child != null) {
      final RenderCloudParentData childParentData = child.parentData;
      childParentData.offset += transCenter;
      child = childParentData.nextSibling;
    }

    ///超过了嘛？
    _needClip =
        size.width &lt; recordRect.width || size.height &lt; recordRect.height;
  }
</code></pre>
<p><strong>其实看完代码可以发现，关键就在于你怎么设置 <code>child.parentData</code> 的 <code>offset</code> ，来控制其位置。</strong></p>
<p>最后通过 <code>CloudWidget</code> 加载我们的 <code>RenderCloudWidget</code> 即可， 当然完整代码还需要结合 <code>FittedBox</code> 与 <code>RotatedBox</code> 简化完成，具体可见 ：<a href="https://github.com/CarGuo/GSYFlutterDemo/tree/master/lib/widget/cloud">GSYFlutterDemo</a></p>
<pre><code class="language-dart">class CloudWidget extends MultiChildRenderObjectWidget {
  final Overflow overflow;
  final double ratio;

  CloudWidget({
    Key key,
    this.ratio = 1,
    this.overflow = Overflow.clip,
    List&lt;Widget&gt; children = const &lt;Widget&gt;[],
  }) : super(key: key, children: children);

  @override
  RenderObject createRenderObject(BuildContext context) {
    return RenderCloudWidget(
      ratio: ratio,
      overflow: overflow,
    );
  }

  @override
  void updateRenderObject(
      BuildContext context, RenderCloudWidget renderObject) {
    renderObject
      ..ratio = ratio
      ..overflow = overflow;
  }
}
</code></pre>
<p>最后我们总结，实现自定义布局的流程就是，实现自定义 <code>RenderBox</code> 中 <code>performLayout</code> <strong>child</strong> 的 <code>offset</code> 。</p>
<h2><a id="custommultichildlayout" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>CustomMultiChildLayout</h2>
<p><code>CustomMultiChildLayout</code> 是 Flutter 为我们封装的简化自定义布局实现，它的内部同样是通过 <code>MultiChildRenderObjectWidget</code> 实现，但是它为我们封装了 <code>RenderCustomMultiChildLayoutBox</code> 和 <code>MultiChildLayoutParentData</code> ，并通过 <code>MultiChildLayoutDelegate</code> 暴露出需要自定义的地方。</p>
<p><img src="media/16880177694288/gif01.gif" alt="gif01" /></p>
<p>使用 <code>CustomMultiChildLayout</code> 你只需要继承 <code>MultiChildLayoutDelegate</code> ，并实现如下方法即可：</p>
<pre><code class="language-dart">  
  void performLayout(Size size);

  bool shouldRelayout(covariant MultiChildLayoutDelegate oldDelegate);
</code></pre>
<p>通过继承 <code>MultiChildLayoutDelegate</code>，并且实现 <code>performLayout</code> 方法，我们可以快速自定义我们需要的控件，当然便捷的封装也代表了灵活性的丧失，可以看到 <code>performLayout</code> 方法中只有布局自身的 <code>Size</code> 参数，所以完成上图需求时，我们还需要 <code>child</code> 的大小和位置 ，也就是 <code>childSize</code> 和 <code>childId</code> 。</p>
<p><code>childSize</code>  相信大家都能故名思义，那 <code>childId</code> 是什么呢？</p>
<p>这就要从 <code>MultiChildLayoutDelegate</code> 的实现说起，在 <code>MultiChildLayoutDelegate</code> 内部会有一个 <code>Map&lt;Object, RenderBox&gt; _idToChild</code>; 对象，这个 <code>Map</code> 对象保存着 <code>Object</code> <code>id</code> 和  <code>RenderBox</code> 的映射关系，而在 <code>MultiChildLayoutDelegate</code> 中获取 <code>RenderBox</code> 都需要通过 <code>id</code> 获取。</p>
<p><code>_idToChild</code> 这个 <code>Map</code> 是在  <code>RenderBox performLayout</code> 时，在 <code>delegate._callPerformLayout</code> 方法内创建的，创建后所用的 <code>id</code> 为 <code>MultiChildLayoutParentData</code> 中的 <code>id</code>， 而 <code>MultiChildLayoutParentData</code> 的 <code>id</code> ，可以通过 <code>LayoutId</code> 嵌套时自定义指定赋值。</p>
<p>而完成上述布局，我们需要知道每个 <code>child</code> 的 <code>index</code> ，所以我们可以把 <code>index</code> 作为 <code>id</code> 设置给每个 <code>child</code> 的 <code>LayoutId</code>。</p>
<p><strong>所以我们可以通过 <code>LayoutId</code> 指定 <code>id</code> 为数字 <code>index</code> ， 同时告知 <code>delegate</code> ，这样我们就知道 <code>child</code> 顺序和位置啦。</strong></p>
<blockquote>
<p>这个 <code>id</code> 是 <code>Object</code> 类型 ，所以你懂得，你可以赋予很多属性进去。</p>
</blockquote>
<p>如下代码所示，这样在自定义的 <code>CircleLayoutDelegate</code> 中，就知道每个控件的 <code>index</code> 位置，也就是知道了，圆形布局中每个 <code>item</code> 需要的位置。</p>
<p>我们只需要通过 <code>index</code> ，计算出 <code>child</code> 所在的角度，然后利用 <code>layoutChild</code> 和 <code>positionChild</code> 对每个<code>item</code>进行布局即可，完整代码:<a href="https://github.com/CarGuo/GSYFlutterDemo/blob/master/lib/widget/custom_multi_render_demo_page.dart">GSYFlutterDemo</a></p>
<pre><code class="language-dart">///自定义实现圆形布局
class CircleLayoutDelegate extends MultiChildLayoutDelegate {
  final List&lt;String&gt; customLayoutId;

  final Offset center;

  Size childSize;

  CircleLayoutDelegate(this.customLayoutId,
      {this.center = Offset.zero, this.childSize});

  @override
  void performLayout(Size size) {
    for (var item in customLayoutId) {
      if (hasChild(item)) {
        double r = 100;

        int index = int.parse(item);

        double step = 360 / customLayoutId.length;

        double hd = (2 * math.pi / 360) * step * index;

        var x = center.dx + math.sin(hd) * r;

        var y = center.dy - math.cos(hd) * r;

        childSize ??= Size(size.width / customLayoutId.length,
            size.height / customLayoutId.length);

        ///设置 child 大小
        layoutChild(item, BoxConstraints.loose(childSize));

        final double centerX = childSize.width / 2.0;

        final double centerY = childSize.height / 2.0;

        var result = new Offset(x - centerX, y - centerY);

        ///设置 child 位置
        positionChild(item, result);
      }
    }
  }

  @override
  bool shouldRelayout(MultiChildLayoutDelegate oldDelegate) =&gt; false;
}
</code></pre>
<p>总的来说，第二种实现方式相对简单，但是也丧失了一定的灵活性，可自定义控制程度更低，但是也更加规范与间接，同时我们自己实现 <code>RenderBox</code> 时，也可以用类似的 <code>delegate</code> 的方式做二次封装，这样的自定义布局会更行规范可控。</p>


    

      </div>

      <div class="row">
        <div class="large-6 columns">
        <p class="text-left" style="padding:15px 0px;">
      
          <a href="16884769811154.html" 
          title="Previous Post: 五步法案例必修课：挂脖空调">&laquo; 五步法案例必修课：挂脖空调</a>
      
        </p>
        </div>
        <div class="large-6 columns">
      <p class="text-right" style="padding:15px 0px;">
      
          <a  href="16879538975586.html" 
          title="Next Post: RenderBox 使用详解">RenderBox 使用详解 &raquo;</a>
      
      </p>
        </div>
      </div>
      <div class="comments-wrap">
        <div class="share-comments">
          

          

          
        </div>
      </div>
    </div><!-- article-wrap -->
  </div><!-- large 8 -->




 <div class="large-4 medium-4 columns">
  <div class="hide-for-small">
    <div id="sidebar" class="sidebar">
          <div id="site-info" class="site-info">
            
                <div class="site-a-logo"><img src="media/16898402251241/logo.jpeg" /></div>
            
                <h1>MagicalRice的Blog</h1>
                <div class="site-des">技术博客</div>
                <div class="social">











  <a target="_blank" class="rss" href="atom.xml" title="RSS">RSS</a>
                
              	 </div>
          	</div>

             

              <div id="site-categories" class="side-item ">
                <div class="side-header">
                  <h2>Categories</h2>
                </div>
                <div class="side-content">

      	<p class="cat-list">
        
            <a href="Android.html"><strong>Android</strong></a>
        
            <a href="%E6%9C%8D%E5%8A%A1%E5%99%A8.html"><strong>服务器</strong></a>
        
            <a href="C++.html"><strong>C++</strong></a>
        
            <a href="UI.html"><strong>UI</strong></a>
        
            <a href="%E4%BB%A3%E7%A0%81%E4%B9%8B%E7%BE%8E.html"><strong>代码之美</strong></a>
        
            <a href="Game.html"><strong>Game</strong></a>
        
            <a href="Python.html"><strong>Python</strong></a>
        
            <a href="Mac.html"><strong>Mac</strong></a>
        
            <a href="%E5%85%B6%E4%BB%96.html"><strong>其他</strong></a>
        
            <a href="Flutter.html"><strong>Flutter</strong></a>
        
            <a href="ReactNative.html"><strong>ReactNative</strong></a>
        
            <a href="Java.html"><strong>Java</strong></a>
        
            <a href="%E9%9F%B3%E8%A7%86%E9%A2%91%E5%BC%80%E5%8F%91.html"><strong>音视频开发</strong></a>
        
            <a href="%E7%BD%91%E7%BB%9C.html"><strong>网络</strong></a>
        
            <a href="%E7%BD%91%E9%A1%B5.html"><strong>网页</strong></a>
        
            <a href="%E5%B7%A5%E5%85%B7-1-2.html"><strong>工具</strong></a>
        
            <a href="%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD.html"><strong>人工智能</strong></a>
        
            <a href="%E5%88%9B%E4%B8%9A.html"><strong>创业</strong></a>
        
            <a href="%E6%80%9D%E7%BB%B4%E6%8F%90%E5%8D%87.html"><strong>思维提升</strong></a>
        
            <a href="GPU%E6%B8%B2%E6%9F%93.html"><strong>GPU渲染</strong></a>
         
        </p>


                </div>
              </div>

              <div id="site-categories" class="side-item">
                <div class="side-header">
                  <h2>Recent Posts</h2>
                </div>
                <div class="side-content">
                <ul class="posts-list">
	      
		      
			      <li class="post">
			        <a href="16946950953153.html">Debian 关闭休眠</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="16946000122919.html">Debian 查看 Linux 硬盘大小、类型和硬件信息</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="16945997927114.html">Debian 查看硬件温度</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="16945994928906.html">Debian 查看Linux版本</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="16945989810086.html">Debian 查看CPU和内存</a>
			      </li>
		     
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		   
		  		</ul>
                </div>
              </div>
        </div><!-- sidebar -->
      </div><!-- hide for small -->
</div><!-- large 4 -->

</div><!-- row -->

 <div class="page-bottom clearfix">
  <div class="row">
   <p class="copyright">Copyright &copy; 2015
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
Theme used <a target="_blank" href="http://github.com">GitHub CSS</a>.</p>
  </div>
</div>

        </section>
      </div>
    </div>

<style>.mweb-charts{background:#fff;}
body{ box-sizing: border-box;
    margin: 0 auto;}
@media print{
    pre, code, pre code {
     overflow: visible !important;
     white-space: pre-wrap !important;       /* css-3 */
     white-space: -moz-pre-wrap !important;  /* Mozilla, since 1999 */
     white-space: -pre-wrap !important;      /* Opera 4-6 */
     white-space: -o-pre-wrap !important;    /* Opera 7 */
     word-wrap: break-word !important;       /* Internet Explorer 5.5+ */
    }
    html,body{margin:0;padding:4px;}
}



div.code-toolbar {
  position: relative;
}

div.code-toolbar > .toolbar {
  position: absolute;
  z-index: 10;
  top: .3em;
  right: .2em;
  transition: opacity 0.3s ease-in-out;
  opacity: 0;
}

div.code-toolbar:hover > .toolbar {
  opacity: 1;
}

/* Separate line b/c rules are thrown out if selector is invalid.
   IE11 and old Edge versions don't support :focus-within. */
div.code-toolbar:focus-within > .toolbar {
  opacity: 1;
}

div.code-toolbar > .toolbar > .toolbar-item {
  display: inline-block;
}

div.code-toolbar > .toolbar > .toolbar-item > a {
  cursor: pointer;
}

div.code-toolbar > .toolbar > .toolbar-item > button {
  background: none;
  border: 0;
  color: inherit;
  font: inherit;
  line-height: normal;
  overflow: visible;
  padding: 0;
  -webkit-user-select: none; /* for button */
  -moz-user-select: none;
  -ms-user-select: none;
}

div.code-toolbar > .toolbar > .toolbar-item > a,
div.code-toolbar > .toolbar > .toolbar-item > button,
div.code-toolbar > .toolbar > .toolbar-item > span {
  color: inherit;
  font-size: .8em;
  padding: 4px .5em;
  background: #f5f2f0;
  background: rgba(224, 224, 224, 0.4);
  box-shadow: 0 2px 0 0 rgba(0,0,0,0.2);
  border-radius: .5em;
}

div.code-toolbar > .toolbar > .toolbar-item > a:hover,
div.code-toolbar > .toolbar > .toolbar-item > a:focus,
div.code-toolbar > .toolbar > .toolbar-item > button:hover,
div.code-toolbar > .toolbar > .toolbar-item > button:focus,
div.code-toolbar > .toolbar > .toolbar-item > span:hover,
div.code-toolbar > .toolbar > .toolbar-item > span:focus {
  color: inherit;
  text-decoration: none;
}
</style><script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script><script>!function(){if("undefined"!=typeof Prism&&"undefined"!=typeof document){var e=[],t={},n=function(){};Prism.plugins.toolbar={};var a=Prism.plugins.toolbar.registerButton=function(n,a){var r;r="function"==typeof a?a:function(e){var t;return"function"==typeof a.onClick?((t=document.createElement("button")).type="button",t.addEventListener("click",(function(){a.onClick.call(this,e)}))):"string"==typeof a.url?(t=document.createElement("a")).href=a.url:t=document.createElement("span"),a.className&&t.classList.add(a.className),t.textContent=a.text,t},n in t?console.warn('There is a button with the key "'+n+'" registered already.'):e.push(t[n]=r)},r=Prism.plugins.toolbar.hook=function(a){var r=a.element.parentNode;var l=a.element.classList;if(l.contains('language-mermaid') || l.contains('language-echarts') || l.contains('language-plantuml')){return;} if(r&&/pre/i.test(r.nodeName)&&!r.parentNode.classList.contains("code-toolbar")){var o=document.createElement("div");o.classList.add("code-toolbar"),r.parentNode.insertBefore(o,r),o.appendChild(r);var i=document.createElement("div");i.classList.add("toolbar");var l=e,d=function(e){for(;e;){var t=e.getAttribute("data-toolbar-order");if(null!=t)return(t=t.trim()).length?t.split(/\s*,\s*/g):[];e=e.parentElement}}(a.element);d&&(l=d.map((function(e){return t[e]||n}))),l.forEach((function(e){var t=e(a);if(t){var n=document.createElement("div");n.classList.add("toolbar-item"),n.appendChild(t),i.appendChild(n)}})),o.appendChild(i)}};a("label",(function(e){var t=e.element.parentNode;if(t&&/pre/i.test(t.nodeName)&&t.hasAttribute("data-label")){var n,a,r=t.getAttribute("data-label");try{a=document.querySelector("template#"+r)}catch(e){}return a?n=a.content:(t.hasAttribute("data-url")?(n=document.createElement("a")).href=t.getAttribute("data-url"):n=document.createElement("span"),n.textContent=r),n}})),Prism.hooks.add("complete",r)}}();</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/toolbar/prism-toolbar.min.css"><script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script><style>div.code-toolbar > .toolbar > .toolbar-item > a, div.code-toolbar > .toolbar > .toolbar-item > button, div.code-toolbar > .toolbar > .toolbar-item > span {padding: 4px .5em; background: #f5f2f0; background: rgba(224, 224, 224, 0.4);}</style>

<style type="text/css">
figure{margin: 0;padding: 0;}
figcaption{text-align:center;}

/* PrismJS 1.14.0
 http://prismjs.com/download.html#themes=prism&languages=markup+css+clike+javascript */
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
    color: black;
    background: none;
    text-shadow: 0 1px white;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;
    
    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;
    
    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
    text-shadow: none;
    background:#b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
    text-shadow: none;
    background: #b3d4fc;
}

@media print {
    code[class*="language-"],
    pre[class*="language-"] {
        text-shadow: none;
    }
}

/* Code blocks */
pre[class*="language-"] {
    padding: 1em;
    margin: .5em 0;
    overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
    background: #F7F7F7;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
    padding: .1em;
    border-radius: .3em;
    white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
    color: slategray;
}

.token.punctuation {
    color: #999;
}

.namespace {
    opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
    color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
    color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
    color: #9a6e3a;
    background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
    color: #07a;
}

.token.function,
.token.class-name {
    color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
    color: #e90;
}

.token.important,
.token.bold {
    font-weight: bold;
}
.token.italic {
    font-style: italic;
}

.token.entity {
    cursor: help;
}


pre[class*="language-"].line-numbers {
    position: relative;
    padding-left: 3.8em;
    counter-reset: linenumber;
}

pre[class*="language-"].line-numbers > code {
    position: relative;
    white-space: inherit;
}

.line-numbers .line-numbers-rows {
    position: absolute;
    pointer-events: none;
    top: 0;
    font-size: 100%;
    left: -3.8em;
    width: 3em; /* works for line-numbers below 1000 lines */
    letter-spacing: -1px;
    border-right: 1px solid #999;

    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;

}

    .line-numbers-rows > span {
        pointer-events: none;
        display: block;
        counter-increment: linenumber;
    }

        .line-numbers-rows > span:before {
            content: counter(linenumber);
            color: #999;
            display: block;
            padding-right: 0.8em;
            text-align: right;
        }

</style>

  
    

    <script src="asset/js/foundation.min.js"></script>
    <script>
      $(document).foundation();
      function fixSidebarHeight(){
        var w1 = $('.markdown-body').height();
          var w2 = $('#sidebar').height();
          if (w1 > w2) { $('#sidebar').height(w1); };
      }
      $(function(){
        fixSidebarHeight();
      })
      $(window).load(function(){
          fixSidebarHeight();
      });
     
    </script>



  </body>
</html>
