<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Android," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="前言对于LayoutInflater之前一直只会用，却不知道LayoutInflater的加载原理，每次直接
1234LayoutInflater.from(context).inflate(R.layout.activity_test, root, false);//不行就这样，反正有一种能实现我要的效果LayoutInflater.from(context).inflate(R.layout.">
<meta property="og:type" content="article">
<meta property="og:title" content="Android-LayoutInflater（布局加载器）">
<meta property="og:url" content="http://adolph.cc/2017/10/14/android-layoutinflater/index.html">
<meta property="og:site_name" content="Magic">
<meta property="og:description" content="前言对于LayoutInflater之前一直只会用，却不知道LayoutInflater的加载原理，每次直接
1234LayoutInflater.from(context).inflate(R.layout.activity_test, root, false);//不行就这样，反正有一种能实现我要的效果LayoutInflater.from(context).inflate(R.layout.">
<meta property="og:image" content="http://ohtrrgyyd.bkt.clouddn.com/20171105150981598486071.png">
<meta property="og:image" content="http://ohtrrgyyd.bkt.clouddn.com/20171105150981625428282.png">
<meta property="og:image" content="http://ohtrrgyyd.bkt.clouddn.com/20171105150981981211425.png">
<meta property="og:image" content="http://ohtrrgyyd.bkt.clouddn.com/20171105150982093163000.png">
<meta property="og:image" content="http://ohtrrgyyd.bkt.clouddn.com/20171105150982208420747.png">
<meta property="og:image" content="http://ohtrrgyyd.bkt.clouddn.com/20171105150982270724112.png">
<meta property="og:image" content="http://ohtrrgyyd.bkt.clouddn.com/20171105150982400667682.png">
<meta property="og:image" content="http://ohtrrgyyd.bkt.clouddn.com/201711041509789321695.jpg">
<meta property="og:image" content="http://ohtrrgyyd.bkt.clouddn.com/20171105150982283383132.gif">
<meta property="og:image" content="http://ohtrrgyyd.bkt.clouddn.com/20171105150982288981203.gif">
<meta property="og:updated_time" content="2017-11-04T19:54:20.024Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android-LayoutInflater（布局加载器）">
<meta name="twitter:description" content="前言对于LayoutInflater之前一直只会用，却不知道LayoutInflater的加载原理，每次直接
1234LayoutInflater.from(context).inflate(R.layout.activity_test, root, false);//不行就这样，反正有一种能实现我要的效果LayoutInflater.from(context).inflate(R.layout.">
<meta name="twitter:image" content="http://ohtrrgyyd.bkt.clouddn.com/20171105150981598486071.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":0,"b2t":true,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://adolph.cc/2017/10/14/android-layoutinflater/"/>





  <title> Android-LayoutInflater（布局加载器） | Magic </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta custom-logo">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Magic</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://adolph.cc/2017/10/14/android-layoutinflater/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="MagicalRice">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ohtrrgyyd.bkt.clouddn.com/037c5bde749f737e107c8fb8e9321c9d.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Magic">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Android-LayoutInflater（布局加载器）
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-14T01:13:00+08:00">
                2017-10-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv">本文总阅读量
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>次
            </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>对于LayoutInflater之前一直只会用，却不知道LayoutInflater的加载原理，每次直接</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">LayoutInflater.from(context).inflate(R.layout.activity_test, root, <span class="keyword">false</span>);</div><div class="line"></div><div class="line"><span class="comment">//不行就这样，反正有一种能实现我要的效果</span></div><div class="line">LayoutInflater.from(context).inflate(R.layout.activity_test, <span class="keyword">null</span>);</div></pre></td></tr></table></figure>
<p>所以，想要趁这个整理博客的机会，顺便把LayoutInflater的内容好好学习学习。</p>
<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><ul>
<li>LayoutInflater的常见使用场景</li>
<li>LayoutInflater的介绍</li>
<li>LayoutInflater相关介绍中的相关概念分析</li>
</ul>
<h1 id="LayoutInflater的常见使用场景"><a href="#LayoutInflater的常见使用场景" class="headerlink" title="LayoutInflater的常见使用场景"></a>LayoutInflater的常见使用场景</h1><p>在介绍之前，我们先回一下，我们在哪些地方都使用过LayoutInflater：</p>
<h2 id="在Activity中"><a href="#在Activity中" class="headerlink" title="在Activity中"></a>在Activity中</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">LayoutInflater inflater = getLayoutInflater();</div><div class="line">View view = inflater.inflate(R.layout.activity_main, <span class="keyword">null</span>);</div></pre></td></tr></table></figure>
<h2 id="在Fragment中"><a href="#在Fragment中" class="headerlink" title="在Fragment中"></a>在Fragment中</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">View view = inflater.inflate(R.layout.fragment_guide_one, container, <span class="keyword">false</span>);</div><div class="line"><span class="keyword">return</span> view;</div></pre></td></tr></table></figure>
<h2 id="在Adapter中"><a href="#在Adapter中" class="headerlink" title="在Adapter中"></a>在Adapter中</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, View convertView, ViewGroup parent)</span> </span>&#123;</div><div class="line">	View view = LayoutInflater.from(convertView.getContext()).inflate(R.layout.activity_main, parent, <span class="keyword">false</span>);</div><div class="line">	<span class="keyword">return</span> view;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="在某些特殊情况下，需要使用LayoutInflater，我们是这样获得它的"><a href="#在某些特殊情况下，需要使用LayoutInflater，我们是这样获得它的" class="headerlink" title="在某些特殊情况下，需要使用LayoutInflater，我们是这样获得它的"></a>在某些特殊情况下，需要使用LayoutInflater，我们是这样获得它的</h2><p><code>LayoutInflater inflater  =(LayoutInflater)context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);</code></p>
<p>上述的使用，是我们平常常见的使用方式，而这些场景都有一个特点，因为这些场景都需要将一个XML布局文件转化成View，所以准确的说<strong>LayoutInflater</strong>的主要功能来说就是布局加载。</p>
<p>其实<strong>LayoutInflater</strong>还有一些扩展操作，可以通过我们自定义的方式来实现，在后面的实战篇会介绍。</p>
<h1 id="LayoutInflater的介绍"><a href="#LayoutInflater的介绍" class="headerlink" title="LayoutInflater的介绍"></a>LayoutInflater的介绍</h1><p>对于LayoutInflater的介绍性质的内容，博主认为，在网上查的任何内容，都不如查阅源码，API来的靠谱一些，因为API才是第一手的介绍资料，而且Android的源码中介绍的也比较完善。</p>
<p>LayoutInflater属于 android.view包下，在LayoutInflater的头部有一段关于LayoutInflater的介绍：</p>
<p><img src="http://ohtrrgyyd.bkt.clouddn.com/20171105150981598486071.png" alt="20171105150981598486071.png"></p>
<p>由于篇幅原因，这里只截取了一部分图片，总结一下：</p>
<ul>
<li>LayoutInflater的主要作用将XML文件实例化成相应的View对象</li>
<li>LayoutInflater在Android开发过程中，获取的方式不是直接new出来的，都是经过这两个方法得到的关联上下文的LayoutInflater：</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">//在Activity中</div><div class="line">LayoutInflater inflater = Activity#getLayoutInflater()</div><div class="line">//其他情况</div><div class="line">LayoutInflater inflater = context.getSystemService(Context.LAYOUT_INFLATER_SERVICE)</div></pre></td></tr></table></figure>
<ul>
<li>如果想使用新的LayoutInflater来加载View，需要使用cloneInContext()，而在新的LayoutInflater需要调用setFactory()设置<strong>视图处理器</strong></li>
<li>由于性能的原因，XML文件的预处理是在Build过程中进行的。</li>
<li>LayoutInflater不能加载未编译的XML文件，而且LayoutInflater只能加载，通过XmlPullParser解析的R文件资源。</li>
</ul>
<h1 id="LayoutInflater介绍相应的解释"><a href="#LayoutInflater介绍相应的解释" class="headerlink" title="LayoutInflater介绍相应的解释"></a>LayoutInflater介绍相应的解释</h1><p>经过上面的总结，大家对LayoutInflater有一个大致的认识，为了大家不是太懵逼，让我一一解释一波。</p>
<h2 id="LayoutInflater的主要作用将XML文件实例化成相应的对象"><a href="#LayoutInflater的主要作用将XML文件实例化成相应的对象" class="headerlink" title="LayoutInflater的主要作用将XML文件实例化成相应的对象"></a>LayoutInflater的主要作用将XML文件实例化成相应的对象</h2><p>其实，大家在使用LayoutInflater时，也会注意到无非就是将布局资源通过LayoutInflater转换为相对应的View，然后在进行一些其他操作,就是<strong>LayoutInflater常见场景</strong>中的几种情况：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">View view = inflater.inflate(R.layout.fragment_guide_one, container, <span class="keyword">false</span>);</div><div class="line"><span class="keyword">return</span> view;</div></pre></td></tr></table></figure>
<h2 id="LayoutInflater在Android开发过程中，不是通过new出来获取到的？"><a href="#LayoutInflater在Android开发过程中，不是通过new出来获取到的？" class="headerlink" title="LayoutInflater在Android开发过程中，不是通过new出来获取到的？"></a>LayoutInflater在Android开发过程中，不是通过new出来获取到的？</h2><p>在上述场景中，除了介绍的两种方式Activity#getLayoutInflater()，以及getSystemService()，大家发现常见场景中还使用了</p>
<p><code>LayoutInflater inflater =LayoutInflater.from(convertView.getContext())；</code></p>
<p>其实LayoutInflater.from()这个方法是官方帮我们封装了一层而已，底层还是调用getSystemService()方法，目的是使LayoutInflater与Context对象相绑定：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LayoutInflater <span class="title">from</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">	LayoutInflater LayoutInflater = (LayoutInflater) context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);</div><div class="line">	<span class="keyword">if</span> (LayoutInflater == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"LayoutInflater not found."</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> LayoutInflater;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="如果想使用新的LayoutInflater来加载，需要使用cloneInContext-，而在新的LayoutInflater需要调用setFactory-设置视图处理器"><a href="#如果想使用新的LayoutInflater来加载，需要使用cloneInContext-，而在新的LayoutInflater需要调用setFactory-设置视图处理器" class="headerlink" title="如果想使用新的LayoutInflater来加载，需要使用cloneInContext()，而在新的LayoutInflater需要调用setFactory()设置视图处理器"></a>如果想使用新的LayoutInflater来加载，需要使用cloneInContext()，而在新的LayoutInflater需要调用setFactory()设置视图处理器</h2><p>正常来说，这种使用方式的使用场景现在也是比较多的，比如：</p>
<ol>
<li>批量获取XML中自定义的属性</li>
<li>动态换肤的效果</li>
<li>动态改变布局中的元素</li>
</ol>
<p>这些都是通过LayoutInflater中的Factory来实现的，而介绍这部分内容会在实战篇来介绍。</p>
<h2 id="由于性能的原因，XML文件的预处理是在Build过程中进行的"><a href="#由于性能的原因，XML文件的预处理是在Build过程中进行的" class="headerlink" title="由于性能的原因，XML文件的预处理是在Build过程中进行的"></a>由于性能的原因，XML文件的预处理是在Build过程中进行的</h2><p>举个例子，在编写XML布局资源时，如果漏写了结束符号，或者一些奇怪的操作，在运行程序之前的Build（构建阶段），就会弹出报错。</p>
<p>这里故意将结束符，写错</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">	<span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">	<span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">	<span class="attr">android:layout_gravity</span>=<span class="string">"center_horizontal"</span></div><div class="line">	<span class="attr">android:textSize</span>=<span class="string">"20sp"</span> /</div></pre></td></tr></table></figure>
<p>这里就会收到报错信息提示，每个XML都会有一个预编译的过程，这个过程发生在构建阶段（Build），而不是运行时。</p>
<p><img src="http://ohtrrgyyd.bkt.clouddn.com/20171105150981625428282.png" alt="20171105150981625428282.png"></p>
<h2 id="LayoutInflater只能加载通过XmlPullParser解析的R文件资源"><a href="#LayoutInflater只能加载通过XmlPullParser解析的R文件资源" class="headerlink" title="LayoutInflater只能加载通过XmlPullParser解析的R文件资源"></a>LayoutInflater只能加载通过XmlPullParser解析的R文件资源</h2><p>这里的R文件资源就是指这些资源文件<br>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">R.layout.xxxx</div><div class="line">R.drawable.xxxx</div><div class="line">R.color.xxx</div><div class="line">R.string.xxx</div></pre></td></tr></table></figure>
<h1 id="二级概述"><a href="#二级概述" class="headerlink" title="二级概述"></a>二级概述</h1><ul>
<li>Activity 的 getSystemService的实现过程</li>
<li>LayoutInflater 如果将布局资源转换为 View 的过程</li>
<li>LayoutInflater的 Factory，Factory2是什么，在解析过程中的作用是什么？</li>
<li>LayoutInflater 的 inflater 方法的各个参数的含义，不同的情况的含义</li>
</ul>
<h1 id="LayoutInflater的构造方法"><a href="#LayoutInflater的构造方法" class="headerlink" title="LayoutInflater的构造方法"></a>LayoutInflater的构造方法</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="title">LayoutInflater</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">	mContext = context;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这种是LayoutInflater常规的构造方法，将Context传入，最后生成的LayoutInflater与对应的Context相绑定。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="title">LayoutInflater</span><span class="params">(LayoutInflater original, Context newContext)</span> </span>&#123;</div><div class="line">	mContext = newContext;</div><div class="line">	mFactory = original.mFactory;</div><div class="line">	mFactory2 = original.mFactory2;</div><div class="line">	mPrivateFactory = original.mPrivateFactory;</div><div class="line">	setFilter(original.mFilter);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>而这种构造方法来说，只是复制原LayoutInflater的内容，然后将Context对象替换，一般来说只会在cloneInContext()方法中使用。</p>
<h1 id="LayoutInflater-form-方法分析"><a href="#LayoutInflater-form-方法分析" class="headerlink" title="LayoutInflater#form()方法分析"></a>LayoutInflater#form()方法分析</h1><p>根据介绍篇的内容，LayoutInflater在Android开发中一般是通过</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);</div><div class="line"></div><div class="line">LayoutInflater.from(context);</div></pre></td></tr></table></figure>
<p>因为第一种方式，已经是LayoutInflater介绍中声明获取的方式之一，那么这里我们看一下LayoutInflater#form的方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LayoutInflater <span class="title">from</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">	LayoutInflater LayoutInflater = (LayoutInflater) context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);</div><div class="line">	<span class="keyword">if</span> (LayoutInflater == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"LayoutInflater not found."</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> LayoutInflater;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从源码上看，LayoutInflater#form()方法内部也是通过getSystemService()方法获得，那么接下来我们看一下context#getSystemService()这个方法：</p>
<p><code>public abstract Object getSystemService(@ServiceName @NonNull String name);</code></p>
<p>发现这个只是一个抽象方法，而我们知道Activity也是Context的一个实现。</p>
<p>Activity#getSystemService()这个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getSystemService</span><span class="params">(@ServiceName @NonNull String name)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (getBaseContext() == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</div><div class="line">			<span class="string">"System services not available to Activities before onCreate()"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//获取WindowManager</span></div><div class="line">	<span class="keyword">if</span> (WINDOW_SERVICE.equals(name)) &#123;</div><div class="line">		<span class="keyword">return</span> mWindowManager;</div><div class="line">		<span class="comment">//系统的搜索框SearchManager</span></div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (SEARCH_SERVICE.equals(name)) &#123;</div><div class="line">		ensureSearchManager();</div><div class="line">		<span class="keyword">return</span> mSearchManager;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">super</span>.getSystemService(name);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从上面看到，在Activity中只处理了两种类型的服务，分别是获取WindowManager、获取SearchManager，那我们接着看其父类的SystemService()方法：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public Object getSystemService(String name) &#123;</div><div class="line">	//找到我们要的东西，注意这是个单例</div><div class="line">	if (LAYOUT_INFLATER_SERVICE.equals(name)) &#123;</div><div class="line">		if (mInflater == null) &#123;</div><div class="line">			mInflater = LayoutInflater.from(getBaseContext()).cloneInContext(this);</div><div class="line">		&#125;</div><div class="line">		return mInflater;</div><div class="line">	&#125;</div><div class="line">	return getBaseContext().getSystemService(name);</div><div class="line">&#125;</div><div class="line"></div><div class="line">在Activity的父类即ContextThemeWrapper的getSystemService()方法中，我们发现了LayoutInflater的创建过程，从上面的代码我们可以看出：</div><div class="line"></div><div class="line">每个Activity内包含的LayoutInflater是一个单例。</div><div class="line"></div><div class="line">Activity创建LayoutInflater时，是先使用最原始的BaseContext创建，然后在将Activity的父类ContextThemeWrapper的信息通过cloneInContext()方法与其绑定。</div><div class="line"></div><div class="line">然后我们在看下LayoutInflater的cloneInContext的实现：</div><div class="line"></div><div class="line">`public abstract LayoutInflater cloneInContext(Context newContext);`</div><div class="line"></div><div class="line">先看下，这个方法的介绍：</div><div class="line"></div><div class="line">![2017110515098197795785.png](http://ohtrrgyyd.bkt.clouddn.com/2017110515098197795785.png)</div><div class="line"></div><div class="line">这个方法通过现有的LayoutInflater创建一个新的LayoutInflater副本，唯一变化的地方是指向不同的上下文对象。</div><div class="line"></div><div class="line">在ContextThemeWrapper通过这个方法创建的新的LayoutInflater还包含了主题的信息。</div><div class="line"></div><div class="line">在ContextThemeWrapper中使用cloneInContext是想将更多的信息，赋予LayoutInflater中，与其相互绑定。</div><div class="line"></div><div class="line"># Activity中LayoutInflater创建</div><div class="line"></div><div class="line">对于Activity的LayoutInflater，其实在Activity创建之时就已经创建完成，但是这一块内容属于FrameWork层的内容，博主道行太浅了，只想带大家看下from这个方法的实现过程。</div><div class="line"></div><div class="line">这里如果大家想了解可以参考下这篇文章</div><div class="line"></div><div class="line">[LayoutInflater源码解析](http://blog.csdn.net/u014486880/article/details/50707672)</div><div class="line"></div><div class="line">而Activity#getLayoutInflater方法：</div><div class="line"></div><div class="line">```java</div><div class="line">@NonNull</div><div class="line">public LayoutInflater getLayoutInflater() &#123;</div><div class="line">	return getWindow().getLayoutInflater();</div><div class="line">&#125;</div><div class="line"></div><div class="line">这个Window对象即PhoneWindow，此时创建出来的LayoutInflater即PhoneLayoutInflater。</div><div class="line"></div><div class="line">这里给大家看下PhoneLayoutInflater的cloneInContext()方法：</div><div class="line"></div><div class="line">```java</div><div class="line">public LayoutInflater cloneInContext(Context newContext) &#123;</div><div class="line">	return new PhoneLayoutInflater(this, newContext);</div><div class="line">&#125;</div><div class="line"></div><div class="line">protected PhoneLayoutInflater(LayoutInflater original, Context newContext) &#123;</div><div class="line">	super(original, newContext);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以发现PhoneLayoutInflater中cloneInContext()的实现，调用了第二个构造方法。</p>
<p>这里在Android Studio是无法查阅的，有条件的可以下载源码，如果下载源码麻烦，可以在这里查阅。</p>
<p><a href="http://androidxref.com/" target="_blank" rel="external">Android源码查看网址</a></p>
<h1 id="将R-layout-xxx转换为View的过程分析"><a href="#将R-layout-xxx转换为View的过程分析" class="headerlink" title="将R.layout.xxx转换为View的过程分析"></a>将R.layout.xxx转换为View的过程分析</h1><p>其实这个过程即LayoutInflater.inflater()这个过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> View <span class="title">inflate</span><span class="params">(@LayoutRes <span class="keyword">int</span> resource, @Nullable ViewGroup root, <span class="keyword">boolean</span> attachToRoot)</span> </span>&#123;</div><div class="line">	<span class="keyword">final</span> Resources res = getContext().getResources();</div><div class="line">	<span class="keyword">if</span> (DEBUG) &#123;</div><div class="line">		Log.d(TAG, <span class="string">"INFLATING from resource: \""</span> + res.getResourceName(resource) + <span class="string">"\" ("</span> + Integer.toHexString(resource) + <span class="string">")"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> XmlResourceParser parser = res.getLayout(resource);</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="keyword">return</span> inflate(parser, root, attachToRoot);</div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line">		parser.close();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这个方法中，只是先拿到XmlResourceParser，用于后续节点的解析，我们接着往下看：</p>
<p>这里只看一些关键的信息，具体代码大家自行查看</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> View <span class="title">inflate</span><span class="params">(XmlPullParser parser, @Nullable ViewGroup root, <span class="keyword">boolean</span> attachToRoot)</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">//》》》》》》》》》》》》》》》》》第一部分》》》》》》》》》》》》》》》》》》》</span></div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.START_TAG &amp;&amp; type != XmlPullParser.END_DOCUMENT) &#123;</div><div class="line">		<span class="comment">// Empty</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (type != XmlPullParser.START_TAG) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> InflateException(parser.getPositionDescription() + <span class="string">": No start tag found!"</span>);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">final</span> String name = parser.getName()</div><div class="line">		<span class="comment">//》》》》》》》》》》》》》》》》》第二部分》》》》》》》》》》》》》》》》》》》</span></div><div class="line">		<span class="keyword">if</span> (TAG_MERGE.equals(name)) &#123;</div><div class="line">			<span class="keyword">if</span> (root == <span class="keyword">null</span> || !attachToRoot) &#123;</div><div class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> InflateException(<span class="string">"&lt;merge /&gt; can be used only with a valid "</span> + <span class="string">"ViewGroup root and attachToRoot=true"</span>);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			rInflate(parser, root, inflaterContext, attrs, <span class="keyword">false</span>);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">//》》》》》》》》》》》》》》》》》第三部分》》》》》》》》》》》》》》》》》》》</span></div><div class="line">			<span class="keyword">final</span> View temp = createViewFromTag(root, name, inflaterContext, attrs);</div><div class="line"></div><div class="line">			ViewGroup.LayoutParams params = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (root != <span class="keyword">null</span>) &#123;</div><div class="line">				params = root.generateLayoutParams(attrs);</div><div class="line">				<span class="keyword">if</span> (!attachToRoot) &#123;</div><div class="line">					temp.setLayoutParams(params);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			rInflateChildren(parser, temp, attrs, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (root != <span class="keyword">null</span> &amp;&amp; attachToRoot) &#123;</div><div class="line">				root.addView(temp, params);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (root == <span class="keyword">null</span> || !attachToRoot) &#123;</div><div class="line">				result = temp;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> result;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="第一部分："><a href="#第一部分：" class="headerlink" title="第一部分："></a>第一部分：</h2><p>这里第一部分的内容，主要是一个XML文件的读取过程，这里有两个判断：</p>
<ul>
<li>遍历XML内容寻找XML标签的开始的标志或者文档结尾的标志才可以跳出循环。</li>
<li>如果该XML没有开始的标识，则抛出异常。</li>
</ul>
<p>下面给大家介绍下，几种常见的解析标识：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">XmlPullParser.START_DOCUMENT                                    文档开始</div><div class="line"></div><div class="line">XmlPullParser.END_DOCUMENT                                      文档结束</div><div class="line"></div><div class="line">XmlPullParser.START_TAG                                         XML标签的开始</div><div class="line"></div><div class="line">XmlPullParser.END_TAG                                           XML标签的结束</div><div class="line"></div><div class="line">XmlPullParser.TEXT                                              XML标签的内容</div></pre></td></tr></table></figure>
<h2 id="第二部分"><a href="#第二部分" class="headerlink" title="第二部分"></a>第二部分</h2><p>这部分的一开始先进行了Merge标签的检验，如果发现该节点是Merge，必须满足父View存在，并且与父View绑定的状态。</p>
<p>转换为代码:</p>
<p><code>root ！= null &amp;&amp; attachToRoot ==true</code></p>
<p>这里Merge是减少布局层级存在的标签，通常和include标签一起使用，所以其必须存在父View，而且merge标签的内容必须与父View绑定。</p>
<p>这里调用rInflate()方法去解析Merge的标签，而rInflate()方法，在另一篇文章已经单独分析。</p>
<p><a href="http://blog.csdn.net/l540675759/article/details/78017065" target="_blank" rel="external">Android 中LayoutInflater（布局加载器）源码篇之rInflate方法</a></p>
<h2 id="第三部分"><a href="#第三部分" class="headerlink" title="第三部分"></a>第三部分</h2><p>我们再看一下第三部分的代码，代码中会有一些简要的说明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">//》》》》》》》》》》》》》》》》》第三部分》》》》》》》》》》》》》》》》》》》</span></div><div class="line">            <span class="comment">//createViewFromTag是一个根据name来创建View的方法</span></div><div class="line">            <span class="keyword">final</span> View temp = createViewFromTag(root, name, inflaterContext, attrs);</div><div class="line"></div><div class="line">            ViewGroup.LayoutParams params = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (root != <span class="keyword">null</span>) &#123;</div><div class="line">                params = root.generateLayoutParams(attrs);</div><div class="line">                <span class="keyword">if</span> (!attachToRoot) &#123;</div><div class="line">                    temp.setLayoutParams(params);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//解析子标签</span></div><div class="line">            rInflateChildren(parser, temp, attrs, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (root != <span class="keyword">null</span> &amp;&amp; attachToRoot) &#123;</div><div class="line">                root.addView(temp, params);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (root == <span class="keyword">null</span> || !attachToRoot) &#123;</div><div class="line">                result = temp;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>将第三部分内容分拆一下主要分为以下几块内容：</p>
<ul>
<li>排除标签为include，或者merge之后，就会通过createViewFromTag()方法来创建View</li>
<li>root是inflater()方法的第二个参数，而attachToRoot是第三个参数，最后会根据这两个参数来决定返回的View</li>
</ul>
<p>在这部分中，<code>createViewFromTag()</code>是根据name（名称），来创建View的一个方法。</p>
<p>接下来，我们要介绍的是inflater()方法中的参数，到底有什么作用？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">    ViewGroup.LayoutParams params = <span class="keyword">null</span>;</div><div class="line">    <span class="comment">//当Root存在</span></div><div class="line">    <span class="keyword">if</span> (root != <span class="keyword">null</span>) &#123;</div><div class="line">        params = root.generateLayoutParams(attrs);</div><div class="line">        <span class="keyword">if</span> (!attachToRoot) &#123;</div><div class="line">            <span class="comment">//设置View在父布局下Params</span></div><div class="line">            temp.setLayoutParams(params);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//遍历子节点</span></div><div class="line">    rInflateChildren(parser, temp, attrs, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">    <span class="comment">//如果Root存在并且attachToRoot为true，即与父View绑定</span></div><div class="line">    <span class="comment">//这里在解析的同时，就会将其添加至父View上</span></div><div class="line">    <span class="keyword">if</span> (root != <span class="keyword">null</span> &amp;&amp; attachToRoot) &#123;</div><div class="line">        root.addView(temp, params);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//如果父Viewwe为null或者没有绑定父View都会将当前解析的View返回，否则返回父View</span></div><div class="line">    <span class="keyword">if</span> (root == <span class="keyword">null</span> || !attachToRoot) &#123;</div><div class="line">        result = temp;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>仔细分析上述代码，可以得出如下结论：</p>
<p>从这段代码中，得出以下几个结论：</p>
<ol>
<li>当root为null时，attachToRoot参数无效，而解析出的View作为一个独立的View存在（不存在LayoutParams）。</li>
<li>当root不为null时，attactToRoot为false，那么会给该View设置一个父View的约束（LayoutParams），然后将其返回。</li>
<li>当root不为null时，attactToRoot为true，那么该View会被直接addView进父View，然后会将父View返回。</li>
<li>当root不为null的话，attactToRoot的默认值是true。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> View <span class="title">inflate</span><span class="params">(XmlPullParser parser, @Nullable ViewGroup root)</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> inflate(parser, root, root != <span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的代码中，我们还少分析了一处代码rInflateChildren()，即解析子类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">rInflateChildren</span><span class="params">(XmlPullParser parser, View parent, AttributeSet attrs,<span class="keyword">boolean</span> finishInflate)</span> <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</div><div class="line">	rInflate(parser, parent, parent.getContext(), attrs, finishInflate);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果你之前没看过这段代码，其实你会像博主之前一样，一直在试，而不知道这段代码正确的含义，但是有时候源码会是一个很好的老师，通过它能够得到你想要的。</p>
<h1 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h1><p><img src="http://ohtrrgyyd.bkt.clouddn.com/20171105150981981211425.png" alt="20171105150981981211425.png"></p>
<h1 id="CreateViewFromTag源码解析"><a href="#CreateViewFromTag源码解析" class="headerlink" title="CreateViewFromTag源码解析"></a>CreateViewFromTag源码解析</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> View <span class="title">createViewFromTag</span><span class="params">(View parent, String name, Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> createViewFromTag(parent, name, context, attrs, <span class="keyword">false</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>createViewFromTag在LayoutInflater中存在重载，最终还是会调用5个参数的createViewFromTag方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="function">View <span class="title">createViewFromTag</span><span class="params">(View parent, String name, Context context, AttributeSet attrs,<span class="keyword">boolean</span> ignoreThemeAttr)</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">//解析view标签</span></div><div class="line">	<span class="keyword">if</span> (name.equals(<span class="string">"view"</span>)) &#123;</div><div class="line">		name = attrs.getAttributeValue(<span class="keyword">null</span>, <span class="string">"class"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//如果需要该标签与主题相关，需要对context进行包装，将主题信息加入context包装类ContextWrapper</span></div><div class="line">	<span class="keyword">if</span> (!ignoreThemeAttr) &#123;</div><div class="line">		<span class="keyword">final</span> TypedArray ta = context.obtainStyledAttributes(attrs, ATTRS_THEME);</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> themeResId = ta.getResourceId(<span class="number">0</span>, <span class="number">0</span>);</div><div class="line">		<span class="keyword">if</span> (themeResId != <span class="number">0</span>) &#123;</div><div class="line">			context = <span class="keyword">new</span> ContextThemeWrapper(context, themeResId);</div><div class="line">		&#125;</div><div class="line">			ta.recycle();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">//BlinkLayout是一种闪烁的FrameLayout，它包裹的内容会一直闪烁，类似QQ提示消息那种。</span></div><div class="line">		<span class="keyword">if</span> (name.equals(TAG_1995)) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">new</span> BlinkLayout(context, attrs);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">//设置Factory，来对View做额外的拓展，这块属于可定制的内容</span></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			View view;</div><div class="line">			<span class="keyword">if</span> (mFactory2 != <span class="keyword">null</span>) &#123;</div><div class="line">				view = mFactory2.onCreateView(parent, name, context, attrs);</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mFactory != <span class="keyword">null</span>) &#123;</div><div class="line">				view = mFactory.onCreateView(name, context, attrs);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				view = <span class="keyword">null</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (view == <span class="keyword">null</span> &amp;&amp; mPrivateFactory != <span class="keyword">null</span>) &#123;</div><div class="line">				view = mPrivateFactory.onCreateView(parent, name, context, attrs);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="comment">//如果此时不存在Factory，不管Factory还是Factory2，还是mPrivateFactory都不存在，那么会直接对name直接进行解析</span></div><div class="line">			<span class="keyword">if</span> (view == <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">final</span> Object lastContext = mConstructorArgs[<span class="number">0</span>];</div><div class="line">				mConstructorArgs[<span class="number">0</span>] = context;</div><div class="line">				<span class="keyword">try</span> &#123;</div><div class="line">					<span class="comment">//如果name中包含.即为自定义View，否则为原生的View控件</span></div><div class="line">					<span class="keyword">if</span> (-<span class="number">1</span> == name.indexOf(<span class="string">'.'</span>)) &#123;</div><div class="line">						view = onCreateView(parent, name, attrs);</div><div class="line">					&#125; <span class="keyword">else</span> &#123;</div><div class="line">						view = createView(name, <span class="keyword">null</span>, attrs);</div><div class="line">					&#125;</div><div class="line">				&#125; <span class="keyword">finally</span> &#123;</div><div class="line">					mConstructorArgs[<span class="number">0</span>] = lastContext;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">		<span class="keyword">return</span> view;</div></pre></td></tr></table></figure>
<p>根据源码可以将createViewFromTag分为三个流程：</p>
<ul>
<li>对一些特殊标签，做分别处理，例如：view，TAG_1995(blink)</li>
<li>进行对Factory、Factory2的设置判断，如果设置那么就会通过设置Factory、Factory2进行生成View</li>
<li>如果没有设置Factory或Factory2，那么就会使用LayoutInflater默认的生成方式，进行View的生成</li>
</ul>
<h2 id="createViewFromTag分析过程："><a href="#createViewFromTag分析过程：" class="headerlink" title="createViewFromTag分析过程："></a>createViewFromTag分析过程：</h2><h3 id="处理view标签"><a href="#处理view标签" class="headerlink" title="处理view标签"></a>处理view标签</h3><p>如果标签的名称是view，注意是小写的view，这个标签一般大家不太常用，具体的使用情况如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;view</div><div class="line">	class=&quot;RelativeLayout&quot;</div><div class="line">	android:layout_width=&quot;match_parent&quot;</div><div class="line">	android:layout_height=&quot;match_parent&quot;&gt;&lt;/view&gt;</div></pre></td></tr></table></figure>
<p>在使用时，相当于所有控件标签的父类一样，可以设置class属性，这个属性会决定view这个节点会变成什么控件。</p>
<h3 id="如果该节点与主题相关，则需要特殊处理"><a href="#如果该节点与主题相关，则需要特殊处理" class="headerlink" title="如果该节点与主题相关，则需要特殊处理"></a>如果该节点与主题相关，则需要特殊处理</h3><p>如果该节点与主题（Theme）相关，需要将context与theme信息包装至ContextWrapper类。</p>
<h3 id="处理TAG-1995标签"><a href="#处理TAG-1995标签" class="headerlink" title="处理TAG_1995标签"></a>处理TAG_1995标签</h3><p>这就有意思了，TAG_1995指的是blink这个标签，这个标签感觉使用的很少，以至于大家根本不知道。</p>
<p>这个标签最后会被解析成BlinkLayout，BlinkLayout其实就是一个FrameLayout，这个控件最后会将包裹内容一直闪烁(就和电脑版QQ消息提示一样)，有空大家可以自行尝试下，很简单，下面贴一下用法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;blink</div><div class="line">	android:layout_width=&quot;wrap_content&quot;</div><div class="line">	android:layout_height=&quot;wrap_content&quot;&gt;</div><div class="line"></div><div class="line">	&lt;TextView</div><div class="line">		android:layout_width=&quot;wrap_content&quot;</div><div class="line">		android:layout_height=&quot;wrap_content&quot;</div><div class="line">		android:text=&quot;这个标签会一直闪烁&quot;/&gt;</div><div class="line">&lt;/blink&gt;</div></pre></td></tr></table></figure>
<h3 id="判断其是否存在Factory或者Factory2"><a href="#判断其是否存在Factory或者Factory2" class="headerlink" title="判断其是否存在Factory或者Factory2"></a>判断其是否存在Factory或者Factory2</h3><p>在这里先对Factory进行判空，这里不管Factory还是Factory2（mPrivateFactory 就是Factory2），本质上都是一种扩展操作，提前解析name，然后直接将解析后的View返回。</p>
<h4 id="Factory"><a href="#Factory" class="headerlink" title="Factory"></a>Factory</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Factory</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(String name, Context context, AttributeSet attrs)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Factory2"><a href="#Factory2" class="headerlink" title="Factory2"></a>Factory2</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Factory2</span> <span class="keyword">extends</span> <span class="title">Factory</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(View parent, String name, Context context, AttributeSet attrs)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从这里可以看出，Factory2和Factory都是一个接口，需要自己实现，而Factory2和Factory的区别是Factory2继承Factory，从而扩展出一个参数，就是增加了该节点的父View。</p>
<p>这里我自定义了一个Factory，下面自定义解析View的过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(String name, Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">	View view = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="keyword">if</span> (-<span class="number">1</span> == name.lastIndexOf(<span class="string">"."</span>)) &#123;</div><div class="line">			<span class="keyword">if</span> (name.equals(<span class="string">"View"</span>) || name.equals(<span class="string">"ViewGroup"</span>)) &#123;</div><div class="line">				view = mInflater.createView(name, <span class="string">"android.view."</span>, attrs);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				view = mInflater.createView(name, <span class="string">"android.widget."</span>, attrs);</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">if</span> (name.contains(<span class="string">"."</span>)) &#123;</div><div class="line">				String checkName = name.substring(name.lastIndexOf(<span class="string">"."</span>));</div><div class="line">				String prefix = name.substring(<span class="number">0</span>, name.lastIndexOf(<span class="string">"."</span>));</div><div class="line">				view = mInflater.createView(checkName, prefix, attrs);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span>(view != <span class="keyword">null</span>)&#123;</div><div class="line">			<span class="comment">//在这里可以对View做一些额外的操作，并且能够获得View的属性集，可以做一些自定义操作。</span></div><div class="line">			view.xxxxxx</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">return</span> view;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从上面可以看出，Factory和Factory2其实LayoutInflater解析View时的一种扩展实现，在这里可以额外的对View处理，设置Factory和Factory2需要通过setFactory()或者setFactory2()来实现。</p>
<p><strong>setFactory()</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFactory</span><span class="params">(Factory factory)</span> </span>&#123;</div><div class="line">	<span class="comment">//如果已经设置Factory，不可以继续设置Factory</span></div><div class="line">	<span class="keyword">if</span> (mFactorySet) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"A factory has already been set on this LayoutInflater"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (factory == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Given factory can not be null"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//设置Factory会添加一个标记</span></div><div class="line">	mFactorySet = <span class="keyword">true</span>;</div><div class="line">	<span class="keyword">if</span> (mFactory == <span class="keyword">null</span>) &#123;</div><div class="line">		mFactory = factory;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		mFactory = <span class="keyword">new</span> FactoryMerger(factory, <span class="keyword">null</span>, mFactory, mFactory2);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>setFactory2()</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFactory2</span><span class="params">(Factory2 factory)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (mFactorySet) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"A factory has already been set on this LayoutInflater"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (factory == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Given factory can not be null"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//注意设置Factory和Factory2的标记是共用的</span></div><div class="line">	mFactorySet = <span class="keyword">true</span>;</div><div class="line">	<span class="keyword">if</span> (mFactory == <span class="keyword">null</span>) &#123;</div><div class="line">		mFactory = mFactory2 = factory;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		mFactory = mFactory2 = <span class="keyword">new</span> FactoryMerger(factory, factory, mFactory, mFactory2);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过上面代码可以看出，Factory和Factory2只能够设置一次，并且Factory和Factory2二者互斥，只能存在一个。</p>
<p>所以一般setFactory()或者setFactory2()，一般在cloneInContext()之后设置，这样生成一个新的LayoutInflater，标记默认是false，才能够设置。</p>
<h3 id="LayoutInflater内置的解析过程"><a href="#LayoutInflater内置的解析过程" class="headerlink" title="LayoutInflater内置的解析过程"></a>LayoutInflater内置的解析过程</h3><p>如果Factory或者Factory2没有设置，或者返回View为null，才会使用默认解析方式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">if (-1 == name.indexOf(&apos;.&apos;)) &#123;</div><div class="line">	view = onCreateView(parent, name, attrs);</div><div class="line">&#125; else &#123;</div><div class="line">	view = createView(name, null, attrs);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段就是对自定义View和原生的控件进行判断，这里给大家说明下原生控件和自定义View的name区别：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">原生 ：  RelativeLayout</div><div class="line">自定义View ： com.demo.guidepagedemo.customview.CustomImageView</div></pre></td></tr></table></figure>
<p>原生控件的解析方式 onCreateView ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> View <span class="title">onCreateView</span><span class="params">(View parent, String name, AttributeSet attrs)</span> <span class="keyword">throws</span> ClassNotFoundException </span>&#123;</div><div class="line">	<span class="keyword">return</span> onCreateView(name, attrs);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后调用的还是2个参数的onCreateView()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> View <span class="title">onCreateView</span><span class="params">(String name, AttributeSet attrs)</span> <span class="keyword">throws</span> ClassNotFoundException </span>&#123;</div><div class="line">	<span class="keyword">return</span> createView(name, <span class="string">"android.view."</span>, attrs);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到最终方法的指向还是调用createView方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> View <span class="title">createView</span><span class="params">(String name, String prefix, AttributeSet attrs)</span> <span class="keyword">throws</span> ClassNotFoundException, InflateException </span>&#123;</div><div class="line">	<span class="comment">//判断构造器是否存在    </span></div><div class="line">	Constructor&lt;? extends View&gt; constructor = sConstructorMap.get(name);</div><div class="line">	<span class="keyword">if</span> (constructor != <span class="keyword">null</span> &amp;&amp; !verifyClassLoader(constructor)) &#123;</div><div class="line">		constructor = <span class="keyword">null</span>;</div><div class="line">		sConstructorMap.remove(name);</div><div class="line">	&#125;</div><div class="line">	Class&lt;? extends View&gt; clazz = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="comment">//如果构造器不存在，这个就相当于Class之前是否被加载过，sConstructorMap就是缓存这些Class的Map</span></div><div class="line">		<span class="keyword">if</span> (constructor == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">//通过前缀+name的方式去加载</span></div><div class="line">			clazz = mContext.getClassLoader().loadClass(prefix != <span class="keyword">null</span> ? (prefix + name) : name).asSubclass(View.class);</div><div class="line">			<span class="comment">//通过过滤去设置一些不需要加载的对象</span></div><div class="line">			<span class="keyword">if</span> (mFilter != <span class="keyword">null</span> &amp;&amp; clazz != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">boolean</span> allowed = mFilter.onLoadClass(clazz);</div><div class="line">				<span class="keyword">if</span> (!allowed) &#123;</div><div class="line">					failNotAllowed(name, prefix, attrs);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			constructor = clazz.getConstructor(mConstructorSignature);</div><div class="line">			constructor.setAccessible(<span class="keyword">true</span>);</div><div class="line">			<span class="comment">//缓存Class</span></div><div class="line">			sConstructorMap.put(name, constructor);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">//如果Class存在，并且加载Class的ClassLoader合法</span></div><div class="line">			<span class="comment">//这里先判断该Class是否应该被过滤</span></div><div class="line">			<span class="keyword">if</span> (mFilter != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="comment">//过滤器也有缓存之前的Class是否被允许加载，判断这个Class的过滤状态</span></div><div class="line">				Boolean allowedState = mFilterMap.get(name);</div><div class="line">				<span class="keyword">if</span> (allowedState == <span class="keyword">null</span>) &#123;</div><div class="line">					<span class="comment">//加载Class对象操作</span></div><div class="line">					clazz = mContext.getClassLoader().loadClass(prefix != <span class="keyword">null</span> ? (prefix + name) : name).asSubclass(View.class);</div><div class="line">					<span class="comment">//判断Class是否可被加载</span></div><div class="line">					<span class="keyword">boolean</span> allowed = clazz != <span class="keyword">null</span> &amp;&amp; mFilter.onLoadClass(clazz);</div><div class="line">					mFilterMap.put(name, allowed);</div><div class="line">					<span class="keyword">if</span> (!allowed) &#123;</div><div class="line">						failNotAllowed(name, prefix, attrs);</div><div class="line">					&#125;</div><div class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (allowedState.equals(Boolean.FALSE)) &#123;</div><div class="line">					failNotAllowed(name, prefix, attrs);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		Object[] args = mConstructorArgs;</div><div class="line">		args[<span class="number">1</span>] = attrs;</div><div class="line"></div><div class="line">		<span class="comment">//如果过滤器不存在，直接实例化该View</span></div><div class="line">		<span class="keyword">final</span> View view = constructor.newInstance(args);</div><div class="line">		<span class="comment">//如果View属于ViewStub那么需要给ViewStub设置一个克隆过的LayoutInflater</span></div><div class="line">		<span class="keyword">if</span> (view <span class="keyword">instanceof</span> ViewStub) &#123;</div><div class="line">			<span class="keyword">final</span> ViewStub viewStub = (ViewStub) view;</div><div class="line">			viewStub.setLayoutInflater(cloneInContext((Context) args[<span class="number">0</span>]));</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> view;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面代码有点长，就直接在代码里面加注释了，这里额外说一下这个方法：</p>
<p>判断ClassLoader是否安全的verifyClassLoader ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">verifyClassLoader</span><span class="params">(Constructor&lt;? extends View&gt; constructor)</span> </span>&#123;</div><div class="line">	<span class="keyword">final</span> ClassLoader constructorLoader = constructor.getDeclaringClass().getClassLoader();</div><div class="line">	<span class="keyword">if</span> (constructorLoader == BOOT_CLASS_LOADER) &#123;</div><div class="line">		<span class="comment">//这里注意BootClassLoader是相当于所有派生出来的ClassLoader的原始基类，所有的ClassLoader都是根据其衍生的。</span></div><div class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//这里是一个遍历操作，一直在遍历加载mContext的ClassLoader的继承树，一直在往上寻找，如果</span></div><div class="line">	<span class="comment">//constructor的ClassLoader与继承树中某个ClassLoader相同就说明这个ClassLoader是安全的</span></div><div class="line">	ClassLoader cl = mContext.getClassLoader();</div><div class="line">	<span class="keyword">do</span> &#123;</div><div class="line">		<span class="keyword">if</span> (constructorLoader == cl) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">		cl = cl.getParent();</div><div class="line">	&#125; <span class="keyword">while</span> (cl != <span class="keyword">null</span>);</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里简单说明下，几种ClassLoader的作用：</p>
<ul>
<li>BootClassLoader 加载Android FrameWork层的一些字节码文件</li>
<li>PathClassLoader 加载已经安装到系统上的应用App（apk）上的字节码文件</li>
<li>DexClassLoader 加载指定目录中的Class字节码文件</li>
<li>BaseDexClassLoader 是PathClassloader和DexClassLoader的父类</li>
</ul>
<p>一般的App刚启动的时候，就会有两个ClassLoader被加载，分别是PathClassLoader、DexClassLoader而这两个ClassLoader都是继承BaseDexClassLoader.</p>
<p>而BaseDexClassLoader继承的是ClassLoader，但是在ClassLoader中getParent()方法赋予其Parent为BootClassLoader，这个如果大家感兴趣，可以自行查阅ClassLoader。</p>
<h1 id="流程图-1"><a href="#流程图-1" class="headerlink" title="流程图"></a>流程图</h1><p><img src="http://ohtrrgyyd.bkt.clouddn.com/20171105150982093163000.png" alt="20171105150982093163000.png"></p>
<h1 id="rInflate-的源码分析"><a href="#rInflate-的源码分析" class="headerlink" title="rInflate()的源码分析"></a>rInflate()的源码分析</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">rInflate</span><span class="params">(XmlPullParser parser, View parent, Context context,AttributeSet attrs, <span class="keyword">boolean</span> finishInflate)</span> <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">//获取该标签的深度</span></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> depth = parser.getDepth();</div><div class="line">	<span class="keyword">int</span> type;</div><div class="line"></div><div class="line">	<span class="keyword">while</span> (((type = parser.next()) != XmlPullParser.END_TAG || parser.getDepth() &gt; depth) &amp;&amp; type != XmlPullParser.END_DOCUMENT) &#123;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (type != XmlPullParser.START_TAG) &#123;</div><div class="line">			<span class="keyword">continue</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">final</span> String name = parser.getName();</div><div class="line"></div><div class="line">		<span class="comment">//如果该节点为requestFocus</span></div><div class="line">		<span class="keyword">if</span> (TAG_REQUEST_FOCUS.equals(name)) &#123;</div><div class="line">			parseRequestFocus(parser, parent);</div><div class="line">			<span class="comment">//如果该节点为tag</span></div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (TAG_TAG.equals(name)) &#123;</div><div class="line">			parseViewTag(parser, parent, attrs);</div><div class="line">			<span class="comment">//如果该节点为include标签</span></div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (TAG_INCLUDE.equals(name)) &#123;</div><div class="line">			<span class="keyword">if</span> (parser.getDepth() == <span class="number">0</span>) &#123;</div><div class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> InflateException(<span class="string">"&lt;include /&gt; cannot be the root element"</span>);</div><div class="line">			&#125;</div><div class="line">			<span class="comment">//解析include标签</span></div><div class="line">			parseInclude(parser, context, parent, attrs);</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (TAG_MERGE.equals(name)) &#123;</div><div class="line">			<span class="comment">//如果该节点为Merge</span></div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> InflateException(<span class="string">"&lt;merge /&gt; must be the root element"</span>);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">//否则属于正常的View</span></div><div class="line">			<span class="keyword">final</span> View view = createViewFromTag(parent, name, context, attrs);</div><div class="line">			<span class="keyword">final</span> ViewGroup viewGroup = (ViewGroup) parent;</div><div class="line">			<span class="keyword">final</span> ViewGroup.LayoutParams params = viewGroup.generateLayoutParams(attrs);</div><div class="line">			<span class="comment">//接下来解析子View</span></div><div class="line">			rInflateChildren(parser, view, attrs, <span class="keyword">true</span>);</div><div class="line">			<span class="comment">//注意这里直接进行addView操作</span></div><div class="line">			viewGroup.addView(view, params);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//如果解析完成，需要通知父View，解析完成。</span></div><div class="line">	<span class="keyword">if</span> (finishInflate) &#123;</div><div class="line">		parent.onFinishInflate();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在rInflate这里做的操作，就是识别这些节点，然后对应解析形成响应的元素，下面我们会根据代码，一段一段分析rInflate都做了什么.</p>
<ul>
<li>如果发现requestFocus标签，则调用父View的requestFocus()方法。</li>
</ul>
<p><strong>requestFocus标签使用</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;EditText  </div><div class="line">	android:id=&quot;@+id/text&quot;  </div><div class="line">	android:layout_width=&quot;match_parent&quot;  </div><div class="line">	android:layout_height=&quot;wrap_content&quot; &gt;  </div><div class="line">	&lt;!-- 当前控件处于焦点状态 --&gt;  </div><div class="line">&lt;requestFocus /&gt;</div></pre></td></tr></table></figure>
<p><strong>parseRequestFocus方法</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseRequestFocus</span><span class="params">(XmlPullParser parser, View view)</span> <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</div><div class="line">	<span class="comment">//调用其父View的requestFocus（）方法</span></div><div class="line">	view.requestFocus();</div><div class="line">	consumeChildElements(parser);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>如果发现tag标签，为其设置（key，value）模式的tag。</li>
</ul>
<p><strong>tag标签使用</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;Button</div><div class="line">	android:id=&quot;@+id/tag_btn&quot;</div><div class="line">	android:layout_width=&quot;match_parent&quot;</div><div class="line">	android:layout_height=&quot;wrap_content&quot;</div><div class="line">	android:onClick=&quot;openClickNotification&quot;</div><div class="line">	android:text=&quot;自定义带监听事件的通知&quot;&gt;</div><div class="line"></div><div class="line">	&lt;tag</div><div class="line">		android:id=&quot;@+id/tag_id&quot;</div><div class="line">		android:value=&quot;@string/app_name&quot; /&gt;</div><div class="line">&lt;/Button&gt;</div></pre></td></tr></table></figure>
<p><strong>parseViewTag</strong>方法 ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseViewTag</span><span class="params">(XmlPullParser parser, View view, AttributeSet attrs)</span> <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</div><div class="line">	<span class="keyword">final</span> Context context = view.getContext();</div><div class="line">	<span class="keyword">final</span> TypedArray ta = context.obtainStyledAttributes(attrs, R.styleable.ViewTag);</div><div class="line">	<span class="comment">//这里设置tag的key</span></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> key = ta.getResourceId(R.styleable.ViewTag_id, <span class="number">0</span>);</div><div class="line">	<span class="comment">//这里设置tag的value</span></div><div class="line">	<span class="keyword">final</span> CharSequence value = ta.getText(R.styleable.ViewTag_value);</div><div class="line">	view.setTag(key, value);</div><div class="line">	ta.recycle();</div><div class="line">	consumeChildElements(parser);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在parseViewTag()方法中，会把（key，value）形式的tag赋予View。</p>
<p>Key指的是R.id.tag_id对应的int类型数据；</p>
<p>Value指的是R.string.app_name的String类型数据；</p>
<ul>
<li>如果是Include标签，这里开始先获取了Include的深度</li>
</ul>
<p><code>final int depth = parser.getDepth();</code></p>
<p>所谓深度就是XML的层级关系，例如这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;!-- outside --&gt;     </div><div class="line">&lt;root&gt;                     </div><div class="line">   sometext                </div><div class="line">   &lt;foobar&gt;                    </div><div class="line">   	&lt;/foobar&gt;                  </div><div class="line">&lt;/root&gt;                    </div><div class="line">&lt;!-- outside --&gt;</div></pre></td></tr></table></figure>
<p>判断该Include标签的深度是否是0，如果为0，则抛出异常，因为include不能为根元素。</p>
<ul>
<li><p>如果是Merge标签，那么会直接抛出异常，因为Merge必须为根元素，也就是深度为0的节点。</p>
</li>
<li><p>最后是其他标签，例如View，一起其他的一些标签</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> View view = createViewFromTag(parent, name, context, attrs);</div><div class="line"><span class="keyword">final</span> ViewGroup viewGroup = (ViewGroup) parent;</div><div class="line"><span class="keyword">final</span> ViewGroup.LayoutParams params = viewGroup.generateLayoutParams(attrs);</div><div class="line">rInflateChildren(parser, view, attrs, <span class="keyword">true</span>);</div><div class="line">viewGroup.addView(view, params);</div></pre></td></tr></table></figure>
<p>在加载View的过程，大致分为三个阶段：</p>
<ul>
<li>createViewFromTag() 见名知意，根据节点名称创建View</li>
<li>rInflateChildren() 加载该节点内子类</li>
<li>parent.addView() 最后将该View添加进Parent布局</li>
</ul>
<h2 id="第一阶段-createViewFromTag"><a href="#第一阶段-createViewFromTag" class="headerlink" title="第一阶段 : createViewFromTag()"></a>第一阶段 : createViewFromTag()</h2><p>createViewFromTag()是根据name(节点名称)来解析出View的一个方法</p>
<h2 id="第二阶段-：rInflateChildren"><a href="#第二阶段-：rInflateChildren" class="headerlink" title="第二阶段 ：rInflateChildren()"></a>第二阶段 ：rInflateChildren()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">rInflateChildren</span><span class="params">(XmlPullParser parser, View parent, AttributeSet attrs,<span class="keyword">boolean</span> finishInflate)</span> <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</div><div class="line">	rInflate(parser, parent, parent.getContext(), attrs, finishInflate);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里可以看到，这里会将解析出来的View作为Root(父View)，继续进行子节点的解析，会继续调用，直到无法解析。</p>
<p>这里的无法解析是指：</p>
<ul>
<li>当前解析的标识为XmlPullParser.END_TAG（节点结束的标识符），并且深度不在父节点的标签内。</li>
<li>或者type 为 XmlPullParser.END_DOCUMENT（文档结束的标识符）。</li>
</ul>
<h2 id="第三阶段-parent-addView-将View添加进父View中"><a href="#第三阶段-parent-addView-将View添加进父View中" class="headerlink" title="第三阶段 parent.addView()将View添加进父View中"></a>第三阶段 parent.addView()将View添加进父View中</h2><p><code>viewGroup.addView(view, params);</code></p>
<p>这段话，不难理解，就是将解析出的View，添加到父View中。</p>
<h1 id="流程图-2"><a href="#流程图-2" class="headerlink" title="流程图"></a>流程图</h1><p><img src="http://ohtrrgyyd.bkt.clouddn.com/20171105150982208420747.png" alt="20171105150982208420747.png"></p>
<h1 id="parseInclude-是在哪里使用的？"><a href="#parseInclude-是在哪里使用的？" class="headerlink" title="parseInclude()是在哪里使用的？"></a>parseInclude()是在哪里使用的？</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">rInflate</span><span class="params">(XmlPullParser parser, View parent, Context context,AttributeSet attrs, <span class="keyword">boolean</span> finishInflate)</span> <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</div><div class="line">	<span class="comment">//----------------省略部分代码--------------------//</span></div><div class="line"></div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (TAG_INCLUDE.equals(name)) &#123;</div><div class="line">	<span class="keyword">if</span> (parser.getDepth() == <span class="number">0</span>) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> InflateException(<span class="string">"&lt;include /&gt; cannot be the root element"</span>);</div><div class="line">	&#125;</div><div class="line">	parseInclude(parser, context, parent, attrs);</div><div class="line">&#125;</div><div class="line"><span class="comment">//----------------省略部分代码--------------------//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从上来代码中，可以发现parseInclude()是在rInflate()中出现，作用是处理当前节点是Include标签时的状况。</p>
<h1 id="parseInclude-源码解析"><a href="#parseInclude-源码解析" class="headerlink" title="parseInclude()源码解析"></a>parseInclude()源码解析</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//参数说明：</span></div><div class="line"><span class="comment">// parser      解析布局的解析器</span></div><div class="line"><span class="comment">// context     当前加载布局的上下文对象</span></div><div class="line"><span class="comment">// parent      父容器</span></div><div class="line"><span class="comment">// attrs       属性集合（XML该节点的属性集合）</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseInclude</span><span class="params">(XmlPullParser parser, Context context, View parent,</span></span></div><div class="line">           AttributeSet attrs) <span class="keyword">throws</span> XmlPullParserException, IOException &#123;</div><div class="line">       <span class="keyword">int</span> type;</div><div class="line"></div><div class="line">       <span class="comment">// 判断 Include标签是否在 ViewGroup容器之内，因为 include 标签只能存在于 ViewGroup 容器之内。</span></div><div class="line"></div><div class="line">       <span class="keyword">if</span> (parent <span class="keyword">instanceof</span> ViewGroup) &#123;</div><div class="line"></div><div class="line">           <span class="comment">//------------------&lt;第一部分&gt;-------------------//</span></div><div class="line"></div><div class="line">           <span class="comment">//当开发者设置 include 主题属性时，可以覆盖被 include 包裹View的主题属性。</span></div><div class="line">           <span class="comment">//但是这种操作很少会使用。</span></div><div class="line">           <span class="comment">//所以如果被包裹 View 设置主题属性，我们在设置就会出现覆盖效果。</span></div><div class="line">           <span class="comment">//以 include 标签的主题属性为最终的主题属性</span></div><div class="line"></div><div class="line">           <span class="comment">//提取出 include 的 thme 属性，如果设置了 them 属性，那么include 包裹的View 设置的 theme 将会无效</span></div><div class="line">           <span class="keyword">final</span> TypedArray ta = context.obtainStyledAttributes(attrs, ATTRS_THEME);</div><div class="line">           <span class="keyword">final</span> <span class="keyword">int</span> themeResId = ta.getResourceId(<span class="number">0</span>, <span class="number">0</span>);</div><div class="line">           <span class="keyword">final</span> <span class="keyword">boolean</span> hasThemeOverride = themeResId != <span class="number">0</span>;</div><div class="line">           <span class="keyword">if</span> (hasThemeOverride) &#123;</div><div class="line">               context = <span class="keyword">new</span> ContextThemeWrapper(context, themeResId);</div><div class="line">           &#125;</div><div class="line">           ta.recycle();</div><div class="line"></div><div class="line"></div><div class="line">           <span class="comment">//------------------&lt;第二部分&gt;-------------------//</span></div><div class="line"></div><div class="line">           <span class="comment">//如果这个属性是指向主题中的某个属性，我们必须设法得到主题中layout 的资源标识符</span></div><div class="line">           <span class="comment">//先获取 layout 属性（资源 id）是否设置</span></div><div class="line">           <span class="keyword">int</span> layout = attrs.getAttributeResourceValue(<span class="keyword">null</span>, ATTR_LAYOUT, <span class="number">0</span>);</div><div class="line">           <span class="keyword">if</span> (layout == <span class="number">0</span>) &#123;</div><div class="line">           <span class="comment">//如果没直接设置布局的资源 id，那么就检索?attr/name这一类的 layout 属性</span></div><div class="line">               <span class="keyword">final</span> String value = attrs.getAttributeValue(<span class="keyword">null</span>, ATTR_LAYOUT);</div><div class="line">               <span class="keyword">if</span> (value == <span class="keyword">null</span> || value.length() &lt;= <span class="number">0</span>) &#123;</div><div class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> InflateException(<span class="string">"You must specify a layout in the"</span></div><div class="line">                           + <span class="string">" include tag: &lt;include layout=\"@layout/layoutID\" /&gt;"</span>);</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               <span class="comment">//从  ?attr/name 这一类的属性中，获取布局属性  </span></div><div class="line">               layout = context.getResources().getIdentifier(value.substring(<span class="number">1</span>), <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="comment">//这个布局资源也许存在主题属性中，所以需要去主题属性中解析</span></div><div class="line">           <span class="keyword">if</span> (mTempValue == <span class="keyword">null</span>) &#123;</div><div class="line">               mTempValue = <span class="keyword">new</span> TypedValue();</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (layout != <span class="number">0</span> &amp;&amp; context.getTheme().resolveAttribute(layout, mTempValue, <span class="keyword">true</span>)) &#123;</div><div class="line">               layout = mTempValue.resourceId;</div><div class="line">           &#125;</div><div class="line"></div><div class="line"></div><div class="line">           <span class="comment">//------------------&lt;第三部分&gt;-------------------//</span></div><div class="line"></div><div class="line">           <span class="keyword">if</span> (layout == <span class="number">0</span>) &#123;</div><div class="line">               <span class="keyword">final</span> String value = attrs.getAttributeValue(<span class="keyword">null</span>, ATTR_LAYOUT);</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> InflateException(<span class="string">"You must specify a valid layout "</span></div><div class="line">                       + <span class="string">"reference. The layout ID "</span> + value + <span class="string">" is not valid."</span>);</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="keyword">final</span> XmlResourceParser childParser = context.getResources().getLayout(layout);</div><div class="line"></div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   <span class="keyword">final</span> AttributeSet childAttrs = Xml.asAttributeSet(childParser);</div><div class="line"></div><div class="line">                   <span class="keyword">while</span> ((type = childParser.next()) != XmlPullParser.START_TAG &amp;&amp;</div><div class="line">                           type != XmlPullParser.END_DOCUMENT) &#123;</div><div class="line">                       <span class="comment">// Empty.</span></div><div class="line">                   &#125;</div><div class="line"></div><div class="line">                   <span class="keyword">if</span> (type != XmlPullParser.START_TAG) &#123;</div><div class="line">                       <span class="keyword">throw</span> <span class="keyword">new</span> InflateException(childParser.getPositionDescription() +</div><div class="line">                               <span class="string">": No start tag found!"</span>);</div><div class="line">                   &#125;</div><div class="line"></div><div class="line">                   <span class="keyword">final</span> String childName = childParser.getName();</div><div class="line"></div><div class="line">                   <span class="keyword">if</span> (TAG_MERGE.equals(childName)) &#123;</div><div class="line">                       <span class="comment">//解析 Meger 标签</span></div><div class="line">                       rInflate(childParser, parent, context, childAttrs, <span class="keyword">false</span>);</div><div class="line">                   &#125; <span class="keyword">else</span> &#123;</div><div class="line">                       <span class="comment">//根据 name名称来创建View</span></div><div class="line">                       <span class="keyword">final</span> View view = createViewFromTag(parent, childName,</div><div class="line">                               context, childAttrs, hasThemeOverride);</div><div class="line">                       <span class="keyword">final</span> ViewGroup group = (ViewGroup) parent;</div><div class="line"></div><div class="line"></div><div class="line">                       <span class="comment">//获取 View 的 id 和其 Visiable 属性</span></div><div class="line">                       <span class="keyword">final</span> TypedArray a = context.obtainStyledAttributes(</div><div class="line">                               attrs, R.styleable.Include);</div><div class="line">                       <span class="keyword">final</span> <span class="keyword">int</span> id = a.getResourceId(R.styleable.Include_id, View.NO_ID);</div><div class="line">                       <span class="keyword">final</span> <span class="keyword">int</span> visibility = a.getInt(R.styleable.Include_visibility, -<span class="number">1</span>);</div><div class="line">                       a.recycle();</div><div class="line"></div><div class="line">                       <span class="comment">//需要将 Parent中的 LayoutParams 设置为其 Params 属性。</span></div><div class="line">                       <span class="comment">//如果 Parent 没有通用的 Params，那么就会抛出Runtime 异常</span></div><div class="line"></div><div class="line">                       <span class="comment">//然后会为其设置 include 包裹内容的通用 Params，</span></div><div class="line"></div><div class="line">                       ViewGroup.LayoutParams params = <span class="keyword">null</span>;</div><div class="line">                       <span class="keyword">try</span> &#123;</div><div class="line">                           params = group.generateLayoutParams(attrs);</div><div class="line">                       &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</div><div class="line">                           <span class="comment">// Ignore, just fail over to child attrs.</span></div><div class="line">                       &#125;</div><div class="line">                       <span class="keyword">if</span> (params == <span class="keyword">null</span>) &#123;</div><div class="line">                           params = group.generateLayoutParams(childAttrs);</div><div class="line">                       &#125;</div><div class="line">                       view.setLayoutParams(params);</div><div class="line"></div><div class="line">                       <span class="comment">// 解析子标签</span></div><div class="line">                       rInflateChildren(childParser, view, childAttrs, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">                       <span class="keyword">if</span> (id != View.NO_ID) &#123;</div><div class="line">                           view.setId(id);</div><div class="line">                       &#125;</div><div class="line"></div><div class="line">                       <span class="comment">// 加载include内容时，需要直接设置其 可见性</span></div><div class="line">                       <span class="keyword">switch</span> (visibility) &#123;</div><div class="line">                           <span class="keyword">case</span> <span class="number">0</span>:</div><div class="line">                               view.setVisibility(View.VISIBLE);</div><div class="line">                               <span class="keyword">break</span>;</div><div class="line">                           <span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">                               view.setVisibility(View.INVISIBLE);</div><div class="line">                               <span class="keyword">break</span>;</div><div class="line">                           <span class="keyword">case</span> <span class="number">2</span>:</div><div class="line">                               view.setVisibility(View.GONE);</div><div class="line">                               <span class="keyword">break</span>;</div><div class="line">                       &#125;</div><div class="line">                       <span class="comment">//添加至父容器中</span></div><div class="line">                       group.addView(view);</div><div class="line">                   &#125;</div><div class="line">               &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                   childParser.close();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> InflateException(<span class="string">"&lt;include /&gt; can only be used inside of a ViewGroup"</span>);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       LayoutInflater.consumeChildElements(parser);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>先把parseInclude()这个方法全景先看下，然后我们在进行分拆，一部分一部分分析。</p>
<h1 id="parseInclude-参数解读"><a href="#parseInclude-参数解读" class="headerlink" title="parseInclude()参数解读"></a>parseInclude()参数解读</h1><p>parseInclude()中分别含义四个参数：</p>
<h2 id="解析器-gt-XmlPullParser-parser"><a href="#解析器-gt-XmlPullParser-parser" class="headerlink" title="解析器 -&gt; XmlPullParser parser"></a>解析器 -&gt; XmlPullParser parser</h2><p>用来解析XML文件的解析器，通过解析器可以得到当前节点的相对应的AttributeSet（属性集）</p>
<h2 id="上下文对象-gt-Context-context"><a href="#上下文对象-gt-Context-context" class="headerlink" title="上下文对象 - &gt; Context context"></a>上下文对象 - &gt; Context context</h2><p>当前加载该XML的上下文对象，并且这个Context与LayoutInflater属于相互绑定关系（一一对应）</p>
<h2 id="父容器-gt-View-parent"><a href="#父容器-gt-View-parent" class="headerlink" title="父容器 - &gt; View parent"></a>父容器 - &gt; View parent</h2><p>包裹该节点的父容器，一般来说都是继承ViewGroup实现的视图组</p>
<h2 id="属性集-gt-AttributeSet-attrs"><a href="#属性集-gt-AttributeSet-attrs" class="headerlink" title="属性集 -&gt; AttributeSet attrs"></a>属性集 -&gt; AttributeSet attrs</h2><p>该节点的属性集，包括所有该节点的相关属性</p>
<h1 id="Include中的theme属性"><a href="#Include中的theme属性" class="headerlink" title="Include中的theme属性"></a>Include中的theme属性</h1><p>这里大家先了解一个相关的问题，关于include标签设置theme属性的情况：</p>
<p>一般来说theme（主题）一般出现在Activtiy的AndroidManifest文件下，来给Activity设置统一的布局效果，而且可以使用如下的操作来进行主题属性的使用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">//  ?attr这样的形式，使用主题中的设置参数</div><div class="line">android:background=&quot;?attr/colorPrimary&quot;</div></pre></td></tr></table></figure>
<p>如果Include标签下设置了新的theme，那么Include中的内容在使用主题属性时，使用的theme主题就是（include）设置的内容，而不是Activity默认下的主题，形成了一种覆盖效果。</p>
<p>也就是说Include标签设置的主题可以覆盖Activity设置的根主题，但是Include设置的主题只作用与Include内部。</p>
<h2 id="举个栗子："><a href="#举个栗子：" class="headerlink" title="举个栗子："></a>举个栗子：</h2><p><strong>style.xml</strong></p>
<p>先定义好两个基础Theme，一个是作为App的基础主题，另一个是include中的主题。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;style name=&quot;AppTheme&quot; parent=&quot;Theme.AppCompat.Light.NoActionBar&quot;&gt;</div><div class="line">	&lt;!-- BaseApplication theme --&gt;</div><div class="line">	&lt;item name=&quot;colorPrimary&quot;&gt;@color/colorPrimary&lt;/item&gt;</div><div class="line">	&lt;item name=&quot;colorPrimaryDark&quot;&gt;@color/colorPrimaryDark&lt;/item&gt;</div><div class="line">	&lt;item name=&quot;colorAccent&quot;&gt;@color/colorAccent&lt;/item&gt;</div><div class="line">&lt;/style&gt;</div><div class="line"></div><div class="line"></div><div class="line">&lt;style name=&quot;IncludeTheme&quot; parent=&quot;Theme.AppCompat.Light.NoActionBar&quot;&gt;</div><div class="line">	&lt;!-- Include Theme --&gt;</div><div class="line">	&lt;item name=&quot;colorPrimary&quot;&gt;@color/colorAccent&lt;/item&gt;</div><div class="line">	&lt;item name=&quot;colorPrimaryDark&quot;&gt;@color/colorAccent&lt;/item&gt;</div><div class="line">	&lt;item name=&quot;colorAccent&quot;&gt;@color/colorAccent&lt;/item&gt;</div><div class="line">&lt;/style&gt;</div></pre></td></tr></table></figure>
<p><strong>AndroidManifest.xml</strong></p>
<p>设置Activity的基础主题为AppTheme</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;activity</div><div class="line">	android:name=&quot;com.demo.MainActivity&quot;</div><div class="line">	android:theme=&quot;@style/AppTheme&quot;&gt;&lt;/activity&gt;</div></pre></td></tr></table></figure>
<p><strong>activity_main.xml</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;RelativeLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;</div><div class="line">    android:orientation=&quot;vertical&quot;&gt;</div><div class="line"></div><div class="line">    &lt;!-- 这里是使用基础Theme的Toolbar --&gt;</div><div class="line">    &lt;android.support.v7.widget.Toolbar</div><div class="line">        android:id=&quot;@+id/activity_theme_tb&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;50dp&quot;</div><div class="line">        android:background=&quot;?attr/colorPrimary&quot; /&gt;</div><div class="line"></div><div class="line">    &lt;!-- 这里是自带Theme Include的Toolbar --&gt;</div><div class="line">    &lt;include</div><div class="line">        layout=&quot;@layout/test_toolbar&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:layout_alignParentBottom=&quot;true&quot;</div><div class="line">        android:theme=&quot;@style/IncludeTheme&quot; /&gt;</div><div class="line"></div><div class="line">&lt;/RelativeLayout&gt;</div></pre></td></tr></table></figure>
<p>接下来，我们在看一下Include包裹的布局 </p>
<p><strong>test_toolbar.xml</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;wrap_content&quot;</div><div class="line">    android:orientation=&quot;vertical&quot;&gt;</div><div class="line"></div><div class="line">    &lt;android.support.v7.widget.Toolbar</div><div class="line">        android:id=&quot;@+id/include_toolbar&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;50dp&quot;</div><div class="line">        android:background=&quot;?attr/colorPrimary&quot; /&gt;</div><div class="line"></div><div class="line">&lt;/LinearLayout&gt;</div></pre></td></tr></table></figure>
<p>从上面的XML文件我们可以看出两个Toolbar调用的background都指向theme的colorPrimary属性，接下来看一下显示效果：</p>
<p><img src="http://ohtrrgyyd.bkt.clouddn.com/20171105150982270724112.png" alt="20171105150982270724112.png"></p>
<p>从效果图可以发现，Include Toolbar显示的颜色是粉色的，也就是Include额外设置的theme，这里也是从正面证明了这个概念。</p>
<h1 id="第一部分：Include-Theme主题的设置"><a href="#第一部分：Include-Theme主题的设置" class="headerlink" title="第一部分：Include Theme主题的设置"></a>第一部分：Include Theme主题的设置</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//------------------&lt;第一部分&gt;-------------------//</span></div><div class="line"><span class="comment">//提取出Theme属性</span></div><div class="line"><span class="keyword">final</span> TypedArray ta = context.obtainStyledAttributes(attrs, ATTRS_THEME);</div><div class="line"><span class="keyword">final</span> <span class="keyword">int</span> themeResId = ta.getResourceId(<span class="number">0</span>, <span class="number">0</span>);</div><div class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> hasThemeOverride = themeResId != <span class="number">0</span>;</div><div class="line"><span class="comment">//如果存在Theme属性，那么Include包含的子标签都会使用该主题</span></div><div class="line"><span class="keyword">if</span> (hasThemeOverride) &#123;</div><div class="line">	context = <span class="keyword">new</span> ContextThemeWrapper(context, themeResId);</div><div class="line">&#125;</div><div class="line">ta.recycle();</div></pre></td></tr></table></figure>
<p>通过上面的介绍，很明显这段代码含义，就是检测是否给Include标签设置了Theme属性，如果设置theme，就创建相应的ContextThemeWrapper，用于之后子标签的解析时theme的使用。</p>
<h1 id="第二部分：Include-内容布局的设置"><a href="#第二部分：Include-内容布局的设置" class="headerlink" title="第二部分：Include 内容布局的设置"></a>第二部分：Include 内容布局的设置</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//------------------&lt;第二部分&gt;-------------------//</span></div><div class="line"><span class="comment">//先获取 layout 属性（资源 id）是否设置</span></div><div class="line"><span class="keyword">int</span> layout = attrs.getAttributeResourceValue(<span class="keyword">null</span>, ATTR_LAYOUT, <span class="number">0</span>);</div><div class="line"><span class="keyword">if</span> (layout == <span class="number">0</span>) &#123;</div><div class="line">	<span class="comment">//如果没直接设置布局的资源 id，那么就检索?attr/name这一类的 layout 属性</span></div><div class="line">	<span class="keyword">final</span> String value = attrs.getAttributeValue(<span class="keyword">null</span>, ATTR_LAYOUT);</div><div class="line">	<span class="keyword">if</span> (value == <span class="keyword">null</span> || value.length() &lt;= <span class="number">0</span>) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> InflateException(<span class="string">"You must specify a layout in the"</span> + <span class="string">" include tag: &lt;include layout=\"@layout/layoutID\" /&gt;"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//从?attr/name 这一类的属性中，获取布局属性  </span></div><div class="line">	layout = context.getResources().getIdentifier(value.substring(<span class="number">1</span>), <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//这个布局资源也许存在主题属性中，所以需要去主题属性中解析</span></div><div class="line"><span class="keyword">if</span> (mTempValue == <span class="keyword">null</span>) &#123;</div><div class="line">	mTempValue = <span class="keyword">new</span> TypedValue();</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (layout != <span class="number">0</span> &amp;&amp; context.getTheme().resolveAttribute(layout, mTempValue, <span class="keyword">true</span>)) &#123;</div><div class="line">	layout = mTempValue.resourceId;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这部分的内容主要是提取Include的内容布局的提取，Include的内容布局的设置有两种：</p>
<h2 id="第一种-：-直接-layout-后面设置布局的XML"><a href="#第一种-：-直接-layout-后面设置布局的XML" class="headerlink" title="第一种 ： 直接@layout 后面设置布局的XML"></a>第一种 ： 直接@layout 后面设置布局的XML</h2><p><code>layout=&quot;@layout/test_toolbar&quot;</code></p>
<h2 id="第二种：通过引入theme的item设置的layout属性"><a href="#第二种：通过引入theme的item设置的layout属性" class="headerlink" title="第二种：通过引入theme的item设置的layout属性"></a>第二种：通过引入theme的item设置的layout属性</h2><h3 id="Include标签下："><a href="#Include标签下：" class="headerlink" title="Include标签下："></a>Include标签下：</h3><p><code>layout=&quot;?attr/theme_layout&quot;</code></p>
<h3 id="包裹Include标签的布局Theme（注意：这里不是Include设置的主题）："><a href="#包裹Include标签的布局Theme（注意：这里不是Include设置的主题）：" class="headerlink" title="包裹Include标签的布局Theme（注意：这里不是Include设置的主题）："></a>包裹Include标签的布局Theme（注意：这里不是Include设置的主题）：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;style name=&quot;AppTheme&quot; parent=&quot;Theme.AppCompat.Light.NoActionBar&quot;&gt;</div><div class="line">	&lt;item name=&quot;colorPrimary&quot;&gt;@color/colorPrimary&lt;/item&gt;</div><div class="line">	&lt;item name=&quot;colorPrimaryDark&quot;&gt;@color/colorPrimaryDark&lt;/item&gt;</div><div class="line">	&lt;item name=&quot;colorAccent&quot;&gt;@color/colorAccent&lt;/item&gt;</div><div class="line">	//重点在这里！！！！！</div><div class="line">	&lt;item name=&quot;theme_layout&quot;&gt;@layout/test_toolbar&lt;/item&gt;</div><div class="line">&lt;/style&gt;</div></pre></td></tr></table></figure>
<p>而上面的代码的作用是检索layout属性，如果layout已经以第一种方式引入，就不需要在去theme中检索，如果layout第一种方式检索不到资源ID，那么就会去以第二种方式进行检索。</p>
<h2 id="第三部分：-Include标签的View处理"><a href="#第三部分：-Include标签的View处理" class="headerlink" title="第三部分： Include标签的View处理"></a>第三部分： Include标签的View处理</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line">    //------------------&lt;第三部分&gt;-------------------//</div><div class="line">    //如果此时还找不到layout，那么必然异常~，会报找不到资源ID的layout异常</div><div class="line">    if (layout == 0) &#123;</div><div class="line">        final String value = attrs.getAttributeValue(null, ATTR_LAYOUT);</div><div class="line">        throw new InflateException(&quot;You must specify a valid layout &quot;</div><div class="line">                + &quot;reference. The layout ID &quot; + value + &quot; is not valid.&quot;);</div><div class="line">    &#125; else &#123;</div><div class="line">    //生成子解析器</div><div class="line">        final XmlResourceParser childParser = context.getResources().getLayout(layout);</div><div class="line"></div><div class="line">        try &#123;</div><div class="line">            final AttributeSet childAttrs = Xml.asAttributeSet(childParser);</div><div class="line">            //----------------省略了XML一些规则的判断----------------//</div><div class="line">            //获取子节点的名称</div><div class="line">            final String childName = childParser.getName();</div><div class="line">            if (TAG_MERGE.equals(childName)) &#123;</div><div class="line">                //解析 Meger 标签</div><div class="line">                rInflate(childParser, parent, context, childAttrs, false);</div><div class="line">            &#125; else &#123;</div><div class="line">                //根据 name名称来创建View</div><div class="line">                final View view = createViewFromTag(parent, childName,</div><div class="line">                        context, childAttrs, hasThemeOverride);</div><div class="line">                final ViewGroup group = (ViewGroup) parent;</div><div class="line">                //获取 View 的 id 和其 Visiable 属性</div><div class="line">                final TypedArray a = context.obtainStyledAttributes(</div><div class="line">                        attrs, R.styleable.Include);</div><div class="line">                final int id = a.getResourceId(R.styleable.Include_id, View.NO_ID);</div><div class="line">                final int visibility = a.getInt(R.styleable.Include_visibility, -1);</div><div class="line">                a.recycle();</div><div class="line"></div><div class="line">                //需要将 Parent中的 LayoutParams 设置为其 Params 属性。</div><div class="line">                //如果 Parent 没有通用的 Params，那么就会抛出Runtime 异常</div><div class="line"></div><div class="line">                //然后会为其设置 include 包裹内容的通用 Params，</div><div class="line"></div><div class="line">                ViewGroup.LayoutParams params = null;</div><div class="line">                try &#123;</div><div class="line">                    params = group.generateLayoutParams(attrs);</div><div class="line">                &#125; catch (RuntimeException e) &#123;</div><div class="line">                    // Ignore, just fail over to child attrs.</div><div class="line">                &#125;</div><div class="line">                if (params == null) &#123;</div><div class="line">                    params = group.generateLayoutParams(childAttrs);</div><div class="line">                &#125;</div><div class="line">                view.setLayoutParams(params);</div><div class="line"></div><div class="line">                // 解析子标签</div><div class="line">                rInflateChildren(childParser, view, childAttrs, true);</div><div class="line"></div><div class="line">                if (id != View.NO_ID) &#123;</div><div class="line">                    view.setId(id);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                // 加载include内容时，需要直接设置其 可见性</div><div class="line">                switch (visibility) &#123;</div><div class="line">                    case 0:</div><div class="line">                        view.setVisibility(View.VISIBLE);</div><div class="line">                        break;</div><div class="line">                    case 1:</div><div class="line">                        view.setVisibility(View.INVISIBLE);</div><div class="line">                        break;</div><div class="line">                    case 2:</div><div class="line">                        view.setVisibility(View.GONE);</div><div class="line">                        break;</div><div class="line">                &#125;</div><div class="line">                //添加至父容器中</div><div class="line">                group.addView(view);</div><div class="line">            &#125;</div><div class="line">        &#125; finally &#123;</div><div class="line">            childParser.close();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125; else &#123;</div><div class="line">    throw new InflateException(&quot;&lt;include /&gt; can only be used inside of a ViewGroup&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这部分主要的作用是解析Include包裹layout的根标签：</p>
<p>###（1）先特别处理Merge标签 ：</p>
<p>如果子节点是Merge标签，那么直接进行内容的解析，调用rInflater()方法。</p>
<p>而rInflater()这个方法的作用是，解析某个节点，根据节点的不同类型从而进行不同的处理</p>
<p>###（2）解析Include的内容：</p>
<p>在这之前先通过createViewFromTag()方法，根据名称来生成相对应的View</p>
<p>这里分成两块内容<br><strong>第一块是设置LayoutParams</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">ViewGroup.LayoutParams params = null;</div><div class="line">try &#123;</div><div class="line">	//加载Include的父ViewGroup的LayoutParams</div><div class="line">	params = group.generateLayoutParams(attrs);</div><div class="line">&#125; catch (RuntimeException e) &#123;</div><div class="line">	// Ignore, just fail over to child attrs.</div><div class="line">&#125;</div><div class="line">if (params == null) &#123;</div><div class="line">	//加载Include的子ViewGroup的LayoutParams</div><div class="line">	params = group.generateLayoutParams(childAttrs);</div><div class="line">&#125;</div><div class="line">view.setLayoutParams(params);</div></pre></td></tr></table></figure>
<p>这段的作用是为Include的包裹的根View设置LayoutParams，使用的LayoutParams默认是Include外层的ViewGroup。</p>
<p>如果此时Params加载失败，那就会使用Include包裹的ViewGroup的LayoutParams，反正怎么都得设置一个。</p>
<p><strong>第二块是在这里设置子ViewGroup的显隐性</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 加载include内容时，需要直接设置其 可见性</span></div><div class="line"><span class="keyword">switch</span> (visibility) &#123;</div><div class="line">	<span class="keyword">case</span> <span class="number">0</span>:</div><div class="line">		view.setVisibility(View.VISIBLE);</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">		view.setVisibility(View.INVISIBLE);</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> <span class="number">2</span>:</div><div class="line">		view.setVisibility(View.GONE);</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">//添加至父容器中</span></div><div class="line">group.addView(view);</div></pre></td></tr></table></figure>
<p>设置ViewGroup的显隐性，之后就将其添加至父View中，至此parseInclude的分析就到此结束。</p>
<h1 id="流程图-3"><a href="#流程图-3" class="headerlink" title="流程图"></a>流程图</h1><p><img src="http://ohtrrgyyd.bkt.clouddn.com/20171105150982400667682.png" alt="20171105150982400667682.png"></p>
<h1 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h1><p><img src="http://ohtrrgyyd.bkt.clouddn.com/201711041509789321695.jpg" alt="201711041509789321695.jpg"></p>
<p><img src="http://ohtrrgyyd.bkt.clouddn.com/20171105150982283383132.gif" alt="20171105150982283383132.gif"></p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>这个效果属于视觉差的效果，原理是根据ViewPager的滑动方向，页面内物理做同向偏移，只要偏移距离大于页面的偏移，就会产生速度差，那么就会实现该效果。</p>
<p>实现速度差，我们需要一个滑动的比例系数：</p>
<p>在页面进入时：</p>
<p><code>页面物体的移动距离 = (页面长度 - 滑动距离) * 滑动系数</code></p>
<p>在页面滑出时：</p>
<p><code>页面物体的移动距离 = （0 - 滑动距离 ） * 滑动系数</code></p>
<p>同时考虑第二张Gif上，发现物体Y轴也存在移动，所以也得需要考虑Y轴方向的滑动，整理下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">//进入时：</div><div class="line">view.setTranslateX((vpWidth - positionOffsetPixels) * xIn);</div><div class="line">view.setTranslateY((vpWidth - positionOffsetPixels) * yIn);</div><div class="line"></div><div class="line">//退出时</div><div class="line">view.setTranslateX((0 - positionOffsetPixels) * xOut);</div><div class="line">view.setTranslateY((0 - positionOffsetPixels) * yOut);</div></pre></td></tr></table></figure>
<p>这样就可以实现出：</p>
<ul>
<li>进入该界面时，界面上的物品快速飞进来。</li>
<li>退出该界面时，界面上的物理快速飞出去。</li>
</ul>
<h1 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h1><p>对于上述的分析，这里的实现思路存在两种：</p>
<ol>
<li>自定义View，自定义xIn、yIn、xOut、yOut四个属性的系数，所有界面上的物体继承这个自定义View。</li>
<li>自定义LayoutInflater.Factory在解析时，将这些自定义属性提取，以Tag方式储存起来。</li>
</ol>
<h1 id="优缺点分析"><a href="#优缺点分析" class="headerlink" title="优缺点分析"></a>优缺点分析</h1><p><strong>自定义View</strong>：</p>
<p>优点：可以对物体做更多层面的扩展，这个自定义LayoutInflater.Factory是不具备的。</p>
<p>缺点：由于界面的物体数量过多，在findViewById时需要处理的View元素过多，极大的增加代码量。</p>
<p><strong>自定义LayoutInflater.Factory</strong> :</p>
<p>优点：可以在解析过程中对View做统一操作，当出现大量的View时，能够缩减大量代码。</p>
<p>缺点：在解析时预处理View，但是就不能动态的改变View的属性，要对View进行扩展性操作，自定义LayoutInflater.Factory不具备这样的功能。</p>
<p><strong>自定义LayoutInflater.Factory</strong></p>
<p>上述的两种方案的优缺点已经分析完毕，但是本文作为实战篇，所以只会介绍自定义LayoutInflater.Factory这种方式。</p>
<p>在实际场景中，需要结合自身情况，以及上述的优缺点，进行合理选择。</p>
<p>在介绍之前，先看一段代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">View view;</div><div class="line">//如果Factory2存在，就会调用其onCreateView方法</div><div class="line">if (mFactory2 != null) &#123;</div><div class="line">	view = mFactory2.onCreateView(parent, name, context, attrs);</div><div class="line">	//如果Factory存在，就会调用其onCreateView方法，和Factory2不同的时，这里的参数没有父View</div><div class="line">&#125; else if (mFactory != null) &#123;</div><div class="line">	view = mFactory.onCreateView(name, context, attrs);</div><div class="line">&#125; else &#123;</div><div class="line">	view = null;</div><div class="line">&#125;</div><div class="line">//如果没有Factory或者Factory2，就会寻找mPrivateFactory（本质上也是Factory2）</div><div class="line">if (view == null &amp;&amp; mPrivateFactory != null) &#123;</div><div class="line">	view = mPrivateFactory.onCreateView(parent, name, context, attrs);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段代码出自LayoutInflater中createViewFromTag()方法，作用是根据View的名称（name参数）来创建View.</p>
<p>在这里就简单描述下，这个方法的主要流程：</p>
<ul>
<li>对一些特殊标签，做分别处理，例如：view，TAG_1995(blink)</li>
<li>进行对Factory、Factory2的设置判断，如果设置那么就会通过设置Factory、Factory2进行生成View</li>
<li>如果没有设置Factory或Factory2，那么就会使用LayoutInflater默认的生成方式，进行View的生成</li>
</ul>
<p>在实战篇中，只有第二部分和我们今天的内容是相关的，我们在看一遍第二条。</p>
<p><code>进行对Factory、Factory2的设置判断，如果设置那么就会通过设置Factory、Factory2进行生成View</code></p>
<p>如果设置了Factory或者Factory2，那么就不会使用LayoutInflater默认的生成方式，那么生成View的过程，就由我们自主把控，这才是我们自定义LayoutInflater.Factory的主要原因。</p>
<h1 id="自定义Factory还是Factory2-？"><a href="#自定义Factory还是Factory2-？" class="headerlink" title="自定义Factory还是Factory2 ？"></a>自定义Factory还是Factory2 ？</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">View view;</div><div class="line"><span class="comment">//如果Factory2存在，就会调用其onCreateView方法</span></div><div class="line"><span class="keyword">if</span> (mFactory2 != <span class="keyword">null</span>) &#123;</div><div class="line">	view = mFactory2.onCreateView(parent, name, context, attrs);</div><div class="line">	<span class="comment">//如果Factory存在，就会调用其onCreateView方法，和Factory2不同的时，这里的参数没有父View</span></div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mFactory != <span class="keyword">null</span>) &#123;</div><div class="line">	view = mFactory.onCreateView(name, context, attrs);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">	view = <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们能够从这段代码中得出，Factory2比Factory的优先级要高，即Factory2存在Factory就不可能会被调用，同理可以得出结论：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">优先级顺序:</div><div class="line"></div><div class="line">mFactory2  &gt; mFactory &gt; mPrivateFactory &gt; LayoutInflater默认处理方式</div></pre></td></tr></table></figure>
<p>而且我们还能够发现mFactory2的onCreateView()方法与mFactory是不相同的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">//mFactory2</div><div class="line">mFactory2.onCreateView(parent, name, context, attrs);</div><div class="line"></div><div class="line">//mFactory</div><div class="line">view = mFactory.onCreateView(name, context, attrs);</div></pre></td></tr></table></figure>
<p>根据上述的分析，我们可以得出结论：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(1)Factory2的调用优先级比Factory要高</div><div class="line"></div><div class="line">(2)Factory2的onCreateView()方法，会比Factory多返回一个父View的参数。</div><div class="line"></div><div class="line">(3)Factory2和Factory是互斥的，（如果不通过反射的话）只能设置一个。</div></pre></td></tr></table></figure>
<p>第三条在CreateViewFromTag的那篇文章已经分析过了，这里不做过多的解释了。</p>
<p>实际选择的过程中，一般会选择自定义Factory2，因为Factory2本身也继承了Factory接口，而且Factory2的优先级比较高。</p>
<h1 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h1><h2 id="设置Factory但是发现无响应，是因为本身LayoutInflater中存在Factory2"><a href="#设置Factory但是发现无响应，是因为本身LayoutInflater中存在Factory2" class="headerlink" title="设置Factory但是发现无响应，是因为本身LayoutInflater中存在Factory2**"></a>设置Factory但是发现无响应，是因为本身LayoutInflater中存在Factory2**</h2><p>因为一般使用方式，是直接调用cloneInContext()方法，我们知道一般的默认解析器都是PhoneLayoutInflater，我们看下其实现方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">protected PhoneLayoutInflater(LayoutInflater original, Context newContext) &#123;</div><div class="line">	super(original, newContext);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>本质就是调用LayoutInflater的两参构造方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">protected LayoutInflater(LayoutInflater original, Context newContext) &#123;</div><div class="line">	mContext = newContext;</div><div class="line">	mFactory = original.mFactory;</div><div class="line">	mFactory2 = original.mFactory2;</div><div class="line">	mPrivateFactory = original.mPrivateFactory;</div><div class="line">	setFilter(original.mFilter);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这里可以看出，cloneInContext会把原LayoutInflater的Factory2和Factory一并复制。</p>
<p>因为Factory比Factory2的优先级低，所以才会不出现效果。</p>
<p><strong>解决方案</strong> ：</p>
<p>（1）自定义LayoutInflater，并且改写cloneInContext，使其不复制原LayoutInflater的Factory2以及Factory。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomLayoutInflater</span> <span class="keyword">extends</span> <span class="title">LayoutInflater</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">CustomLayoutInflater</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> LayoutInflater <span class="title">cloneInContext</span><span class="params">(Context newContext)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CustomLayoutInflater(newContext);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>（2）使用时，直接通过new出实例，然后setFactory</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">CustomLayoutInflater newInflater = <span class="keyword">new</span> CustomLayoutInflater(getActivity());</div><div class="line">newInflater.setFactory2(<span class="keyword">new</span> CustomAppFactory(newInflater, <span class="keyword">this</span>));</div><div class="line"><span class="keyword">return</span> newInflater.inflate(layoutId, <span class="keyword">null</span>);</div></pre></td></tr></table></figure>
<h2 id="使用AppCompatActivity直接setFactory2或者setFactory为什么报错？"><a href="#使用AppCompatActivity直接setFactory2或者setFactory为什么报错？" class="headerlink" title="使用AppCompatActivity直接setFactory2或者setFactory为什么报错？"></a>使用AppCompatActivity直接setFactory2或者setFactory为什么报错？</h2><p>这是因为 AppCompatActivity 在初始化的时候，已经设置了 Factory，下面来看下这部分代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">	<span class="keyword">final</span> AppCompatDelegate delegate = getDelegate();</div><div class="line">	<span class="comment">//注意这个方法</span></div><div class="line">	delegate.installViewFactory();</div><div class="line">	delegate.onCreate(savedInstanceState);</div><div class="line">	<span class="comment">//.....省略多余的代码..........</span></div><div class="line">	<span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>继续查看 installViewFactory（）方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">installViewFactory</span><span class="params">()</span> </span>&#123;</div><div class="line">	LayoutInflater layoutInflater = LayoutInflater.from(mContext);</div><div class="line">	<span class="keyword">if</span> (layoutInflater.getFactory() == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">//这句话是设置 Factory 的方法</span></div><div class="line">		LayoutInflaterCompat.setFactory(layoutInflater, <span class="keyword">this</span>);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">//省略部分代码。。。。。。      </span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以发现，在onCreate 时 LayoutInflater 已经设置过一次 Factory 了，然后我再来看下 setFactory() 的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFactory</span><span class="params">(Factory factory)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (mFactorySet) &#123;</div><div class="line">		<span class="comment">//原因就是这一句</span></div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"A factory has already been set on this LayoutInflater"</span>);</div><div class="line">	&#125;</div><div class="line">	mFactorySet = <span class="keyword">true</span>;</div><div class="line">	<span class="keyword">if</span> (mFactory == <span class="keyword">null</span>) &#123;</div><div class="line">		mFactory = factory;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		mFactory = <span class="keyword">new</span> FactoryMerger(factory, <span class="keyword">null</span>, mFactory, mFactory2);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>根据上面代码，就可以发现报错原因了。</p>
<p><strong>解决方案</strong> ：</p>
<p>在使用前，先使用 cloneInContext()克隆出一个新的 LayoutInflater，然后在进行设置操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">LayoutInflate  newInflater = LayoutInflater.cloneInContext(inflater,context);</div><div class="line"></div><div class="line">newInflater.setFactory(new CustomFactory（）)；</div></pre></td></tr></table></figure>
<p>这样就避开在原 LayoutInflater 设置 Factory 报错了。</p>
<h1 id="自定义Factory2的实现-——-gt-CustomAppFactory"><a href="#自定义Factory2的实现-——-gt-CustomAppFactory" class="headerlink" title="自定义Factory2的实现 ——&gt; CustomAppFactory"></a>自定义Factory2的实现 ——&gt; CustomAppFactory</h1><p>根据上面的展示效果，我们可以判断出是ViewPager + Fragment的风格，所以我们自定义Factory应该在Fragment的onCreateView中，更改LayoutInflater。</p>
<p>而且根据注意事项，我们一般会自定义优先级较高的Factory2，防止本身cloneInContext的LayoutInflater中已经存在Factory2，我们使用Factory会无效。</p>
<h2 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">public View onCreateView(LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState) &#123;</div><div class="line">	Bundle bundle = getArguments();</div><div class="line">	int layoutId = bundle.getInt(LAYOUT_ID);</div><div class="line">	//注意需要调用cloneInContext方法生成新的LayoutInflater</div><div class="line">	LayoutInflater newInflater = inflater.cloneInContext(getActivity());</div><div class="line">	//调用的是setFactory2而非setFactory</div><div class="line">	newInflater.setFactory2(new CustomAppFactory(newInflater, this));</div><div class="line">	return newInflater.inflate(layoutId, null);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="自定义过程"><a href="#自定义过程" class="headerlink" title="自定义过程"></a>自定义过程</h2><p>那么就创建一个类CustomAppFactory来实现Factory2的接口，复写onCreateView的方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(String name, Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">	View view = <span class="keyword">null</span>;</div><div class="line">	<span class="comment">//&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;第一部分&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span></div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="keyword">if</span> (name.contains(<span class="string">"."</span>)) &#123;</div><div class="line">			String checkName = name.substring(name.lastIndexOf(<span class="string">"."</span>));</div><div class="line">			String prefix = name.substring(<span class="number">0</span>, name.lastIndexOf(<span class="string">"."</span>));</div><div class="line">			view = defaultInflater(checkName, prefix, attrs);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (name.equals(<span class="string">"View"</span>) || name.equals(<span class="string">"ViewGroup"</span>)) &#123;</div><div class="line">			view = defaultInflater(name, sClassPrefix[<span class="number">1</span>], attrs);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			view = defaultInflater(name, sClassPrefix[<span class="number">0</span>], attrs);</div><div class="line">		&#125;</div><div class="line">		<span class="comment">//&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;第二部分&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span></div><div class="line">		<span class="comment">//实例化完成</span></div><div class="line">		<span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">//获取自定义属性,通过标签关联到视图上</span></div><div class="line">			setViewTag(view, context, attrs);</div><div class="line">			mInflaterView.addView(view);</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">		e.printStackTrace();</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> view;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(View parent, String name, Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">	View view = onCreateView(name, context, attrs);</div><div class="line">	<span class="keyword">return</span> view;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其实如果我们采取自定义的方式，这里只会调用onCreateView()四位参数的方法，因为在比较Factory2和Factory的代码也介绍过了。</p>
<p>我们实现的逻辑是在onCreateView()三位逻辑里面，因为需要实现的效果不需要Parent（父View），所以这里逻辑实现全在三位参数的onCreateView()中。</p>
<p>在这里我们将onCreateView()中，分成2部分内容：</p>
<ul>
<li>根据名称解析出View</li>
<li>扩展操作，将额外的属性，提取出来储存在Tag中</li>
</ul>
<h1 id="onCreateView第一部分内容"><a href="#onCreateView第一部分内容" class="headerlink" title="onCreateView第一部分内容"></a>onCreateView第一部分内容</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (name.contains(<span class="string">"."</span>)) &#123;</div><div class="line">	String checkName = name.substring(name.lastIndexOf(<span class="string">"."</span>));</div><div class="line">	String prefix = name.substring(<span class="number">0</span>, name.lastIndexOf(<span class="string">"."</span>));</div><div class="line">	view = defaultInflater(checkName, prefix, attrs);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (name.equals(<span class="string">"View"</span>) || name.equals(<span class="string">"ViewGroup"</span>)) &#123;</div><div class="line">	view = defaultInflater(name, sClassPrefix[<span class="number">1</span>], attrs);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">	view = defaultInflater(name, sClassPrefix[<span class="number">0</span>], attrs);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里判断了name中是否包含“.”，是用来判断生成的View是否是自定义View，下面来看下自定义View和Android自带的组件的区别：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">//原生的组件</div><div class="line">RelativeLayout</div><div class="line">//自定义View</div><div class="line">com.demo.guidepagedemo.customview.CustomImageView</div></pre></td></tr></table></figure>
<p>可以发现区别为原生的View不带前缀，而自定义View是包括前缀的，所以会用name.contains(“.”)来区分。</p>
<p>而原生组件中View和ViewGroup是属于android.view包下，其他的例如：RelativeLayout，LinearLayout是属于android.widget包下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">private final String[] sClassPrefix = &#123;</div><div class="line">	&quot;android.widget.&quot;,</div><div class="line">	&quot;android.view.&quot;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>所以在之后会对View和ViewGroup作区分，上面把sClassPrefix贴出来了。</p>
<p>而这里真正的解析过程最后还是交给LayoutInflater，调用LayoutInflater的onCreateView方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> View <span class="title">defaultInflater</span><span class="params">(String name, String prefix, AttributeSet attrs)</span> </span>&#123;</div><div class="line">	View view = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		view = mInflater.createView(name, prefix, attrs);</div><div class="line">	&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">		e.printStackTrace();</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> view;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="onCreateView第二部分内容"><a href="#onCreateView第二部分内容" class="headerlink" title="onCreateView第二部分内容"></a>onCreateView第二部分内容</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//实例化完成</span></div><div class="line"><span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</div><div class="line">	<span class="comment">//获取自定义属性,通过标签关联到视图上</span></div><div class="line">	setViewTag(view, context, attrs);</div><div class="line">	mInflaterView.addView(view);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这里做拓展处理的，setViewTag方法是处理View的自定义属性，然后将这些属性包装成类，给View设置Tag</p>
<p><strong>setViewTag方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 将View的属性信息存储在Tag中</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setViewTag</span><span class="params">(View view, Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">	<span class="comment">//解析自定义的属性</span></div><div class="line">	TypedArray array = context.obtainStyledAttributes(attrs, R.styleable.CustomImageView);</div><div class="line">	<span class="keyword">if</span> (attrs != <span class="keyword">null</span> &amp;&amp; array.length() &gt; <span class="number">0</span>) &#123;</div><div class="line">		AttrTagBean bean = <span class="keyword">new</span> AttrTagBean();</div><div class="line">		bean.xIn = array.getFloat(R.styleable.CustomImageView_in_value_x, <span class="number">0f</span>);</div><div class="line">		bean.xOut = array.getFloat(R.styleable.CustomImageView_out_value_x, <span class="number">0f</span>);</div><div class="line">		bean.yIn = array.getFloat(R.styleable.CustomImageView_in_value_y, <span class="number">0f</span>);</div><div class="line">		bean.yOut = array.getFloat(R.styleable.CustomImageView_out_value_y, <span class="number">0f</span>);</div><div class="line">		<span class="comment">//index</span></div><div class="line">		view.setTag(bean);</div><div class="line">	&#125;</div><div class="line">	array.recycle();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面对应的是本文我们开始设置的4个系数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">R.styleable.CustomImageView_in_value_x              --&gt;   进入时 x方向的系数</div><div class="line"></div><div class="line">R.styleable.CustomImageView_out_value_x             --&gt;   退出时 x方向的系数</div><div class="line"></div><div class="line">R.styleable.CustomImageView_in_value_y              --&gt;   进入时 y方向的系数</div><div class="line"></div><div class="line">R.styleable.CustomImageView_out_value_y             --&gt;   退出时 y方向的系数</div></pre></td></tr></table></figure>
<p>而这里的mInflaterView是一个抽象接口，让Fragment来实现的，通过在Fragment中内置一个List《View》，到时候可以遍历统一操作这些View，下面是实现过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InflaterViewImpl</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 获取View集合</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function">List&lt;View&gt; <span class="title">getViews</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 添加元素</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>Fragment中的实现过程</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PageFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> <span class="keyword">implements</span> <span class="title">InflaterViewImpl</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> List&lt;View&gt; views = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line">    <span class="comment">//**************篇幅原因省略了部分方法************************//</span></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;View&gt; <span class="title">getViews</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> views;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (views.contains(view)) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        views.add(view);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="处理ViewPager的滑动"><a href="#处理ViewPager的滑动" class="headerlink" title="处理ViewPager的滑动"></a>处理ViewPager的滑动</h1><p>这是实战篇的最后一部分内容，主要介绍的是ViewPager的滑动监听相关的处理，因为所有效果是基于ViewPager的滑动监听来显示的。</p>
<p>因为本文主要介绍内容是自定义LayoutInflater.Factory，所以这里会简单叙述下：</p>
<p>```java<br>mInflaterVp.addOnPageChangeListener(new ViewPager.OnPageChangeListener() {<br>    @Override<br>    public void onPageScrolled(int position, float positionOffset, int positionOffsetPixels) {<br>        //获取ViewPager的宽度<br>        int vpWidth = mInflaterVp.getWidth();<br>        //获取正在进入的界面<br>        PageFragment inFragment = getPosition(position - 1);<br>        if (inFragment != null) {<br>            List<view> views = inFragment.getViews();<br>            if (views != null &amp;&amp; views.size() &gt; 0) {<br>            for (View view : views) {<br>                AttrTagBean tag = (AttrTagBean) view.getTag();<br>                if (tag != null) {<br>                    view.setTranslationX((vpWidth - positionOffsetPixels) <em> tag.xIn);<br>                    view.setTranslationY((vpWidth - positionOffsetPixels) </em> tag.yIn);<br>                }<br>            }<br>        }<br>    }</view></p>
<pre><code>//当前正在滑动的界面
PageFragment outFragment = getPosition(position);
if (outFragment != null) {
    List&lt;View&gt; views = outFragment.getViews();
    if (views != null &amp;&amp; views.size() &gt; 0) {
        for (View view : views) {
            AttrTagBean tag = (AttrTagBean) view.getTag();
            if (tag != null) {
                view.setTranslationX((0 - positionOffsetPixels) * tag.xOut);
                view.setTranslationY((0 - positionOffsetPixels) * tag.yOut);
            }
        }
    }
}


@Override
public void onPageSelected(int position) {
    //当划到最后一页时，小人的图标消失
    if (position == fragments.size() - 1) {
        mInflaterIv.setVisibility(View.GONE);
    } else {
        mInflaterIv.setVisibility(View.VISIBLE);
    }
}

@Override
public void onPageScrollStateChanged(int state) {
    //这里是处理图中的小人的帧动画过程
    Drawable anim = mInflaterIv.getBackground();
    if (!(anim instanceof AnimationDrawable)) {
        return;
    }
    AnimationDrawable animation = (AnimationDrawable) anim;
    Log.d(&quot;滑动状态&quot;, state + &quot;&quot;);
    switch (state) {
        //空闲状态
        case ViewPager.SCROLL_STATE_IDLE:
            animation.stop();
            break;
        //拖动状态
        case ViewPager.SCROLL_STATE_DRAGGING:
            animation.start();
            break;
        //惯性滑动状态
        case ViewPager.SCROLL_STATE_SETTLING:
            break;
    }
}
</code></pre><p>});</p>
<p>小红书引导页</p>
<p><img src="http://ohtrrgyyd.bkt.clouddn.com/20171105150982288981203.gif" alt="20171105150982288981203.gif"></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/10/12/android-camera-matrix/" rel="next" title="Android-Camera和Matrix实现真正的3D(WheelView)日期,地址选择滚轮控件">
                <i class="fa fa-chevron-left"></i> Android-Camera和Matrix实现真正的3D(WheelView)日期,地址选择滚轮控件
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/10/15/android-study-particle/" rel="prev" title="Android-粒子变幻、隧道散列、组合文字">
                Android-粒子变幻、隧道散列、组合文字 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://ohtrrgyyd.bkt.clouddn.com/037c5bde749f737e107c8fb8e9321c9d.jpg"
               alt="MagicalRice" />
          <p class="site-author-name" itemprop="name">MagicalRice</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">138</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">16</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">25</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/adolphJane" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#概述"><span class="nav-number">2.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#LayoutInflater的常见使用场景"><span class="nav-number">3.</span> <span class="nav-text">LayoutInflater的常见使用场景</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#在Activity中"><span class="nav-number">3.1.</span> <span class="nav-text">在Activity中</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#在Fragment中"><span class="nav-number">3.2.</span> <span class="nav-text">在Fragment中</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#在Adapter中"><span class="nav-number">3.3.</span> <span class="nav-text">在Adapter中</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#在某些特殊情况下，需要使用LayoutInflater，我们是这样获得它的"><span class="nav-number">3.4.</span> <span class="nav-text">在某些特殊情况下，需要使用LayoutInflater，我们是这样获得它的</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#LayoutInflater的介绍"><span class="nav-number">4.</span> <span class="nav-text">LayoutInflater的介绍</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#LayoutInflater介绍相应的解释"><span class="nav-number">5.</span> <span class="nav-text">LayoutInflater介绍相应的解释</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#LayoutInflater的主要作用将XML文件实例化成相应的对象"><span class="nav-number">5.1.</span> <span class="nav-text">LayoutInflater的主要作用将XML文件实例化成相应的对象</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LayoutInflater在Android开发过程中，不是通过new出来获取到的？"><span class="nav-number">5.2.</span> <span class="nav-text">LayoutInflater在Android开发过程中，不是通过new出来获取到的？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如果想使用新的LayoutInflater来加载，需要使用cloneInContext-，而在新的LayoutInflater需要调用setFactory-设置视图处理器"><span class="nav-number">5.3.</span> <span class="nav-text">如果想使用新的LayoutInflater来加载，需要使用cloneInContext()，而在新的LayoutInflater需要调用setFactory()设置视图处理器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#由于性能的原因，XML文件的预处理是在Build过程中进行的"><span class="nav-number">5.4.</span> <span class="nav-text">由于性能的原因，XML文件的预处理是在Build过程中进行的</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LayoutInflater只能加载通过XmlPullParser解析的R文件资源"><span class="nav-number">5.5.</span> <span class="nav-text">LayoutInflater只能加载通过XmlPullParser解析的R文件资源</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二级概述"><span class="nav-number">6.</span> <span class="nav-text">二级概述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#LayoutInflater的构造方法"><span class="nav-number">7.</span> <span class="nav-text">LayoutInflater的构造方法</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#LayoutInflater-form-方法分析"><span class="nav-number">8.</span> <span class="nav-text">LayoutInflater#form()方法分析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#将R-layout-xxx转换为View的过程分析"><span class="nav-number">9.</span> <span class="nav-text">将R.layout.xxx转换为View的过程分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#第一部分："><span class="nav-number">9.1.</span> <span class="nav-text">第一部分：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第二部分"><span class="nav-number">9.2.</span> <span class="nav-text">第二部分</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第三部分"><span class="nav-number">9.3.</span> <span class="nav-text">第三部分</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#流程图"><span class="nav-number">10.</span> <span class="nav-text">流程图</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CreateViewFromTag源码解析"><span class="nav-number">11.</span> <span class="nav-text">CreateViewFromTag源码解析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#createViewFromTag分析过程："><span class="nav-number">11.1.</span> <span class="nav-text">createViewFromTag分析过程：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#处理view标签"><span class="nav-number">11.1.1.</span> <span class="nav-text">处理view标签</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如果该节点与主题相关，则需要特殊处理"><span class="nav-number">11.1.2.</span> <span class="nav-text">如果该节点与主题相关，则需要特殊处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#处理TAG-1995标签"><span class="nav-number">11.1.3.</span> <span class="nav-text">处理TAG_1995标签</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#判断其是否存在Factory或者Factory2"><span class="nav-number">11.1.4.</span> <span class="nav-text">判断其是否存在Factory或者Factory2</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Factory"><span class="nav-number">11.1.4.1.</span> <span class="nav-text">Factory</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Factory2"><span class="nav-number">11.1.4.2.</span> <span class="nav-text">Factory2</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LayoutInflater内置的解析过程"><span class="nav-number">11.1.5.</span> <span class="nav-text">LayoutInflater内置的解析过程</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#流程图-1"><span class="nav-number">12.</span> <span class="nav-text">流程图</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#rInflate-的源码分析"><span class="nav-number">13.</span> <span class="nav-text">rInflate()的源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#第一阶段-createViewFromTag"><span class="nav-number">13.1.</span> <span class="nav-text">第一阶段 : createViewFromTag()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第二阶段-：rInflateChildren"><span class="nav-number">13.2.</span> <span class="nav-text">第二阶段 ：rInflateChildren()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第三阶段-parent-addView-将View添加进父View中"><span class="nav-number">13.3.</span> <span class="nav-text">第三阶段 parent.addView()将View添加进父View中</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#流程图-2"><span class="nav-number">14.</span> <span class="nav-text">流程图</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#parseInclude-是在哪里使用的？"><span class="nav-number">15.</span> <span class="nav-text">parseInclude()是在哪里使用的？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#parseInclude-源码解析"><span class="nav-number">16.</span> <span class="nav-text">parseInclude()源码解析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#parseInclude-参数解读"><span class="nav-number">17.</span> <span class="nav-text">parseInclude()参数解读</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#解析器-gt-XmlPullParser-parser"><span class="nav-number">17.1.</span> <span class="nav-text">解析器 -> XmlPullParser parser</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#上下文对象-gt-Context-context"><span class="nav-number">17.2.</span> <span class="nav-text">上下文对象 - > Context context</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#父容器-gt-View-parent"><span class="nav-number">17.3.</span> <span class="nav-text">父容器 - > View parent</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#属性集-gt-AttributeSet-attrs"><span class="nav-number">17.4.</span> <span class="nav-text">属性集 -> AttributeSet attrs</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Include中的theme属性"><span class="nav-number">18.</span> <span class="nav-text">Include中的theme属性</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#举个栗子："><span class="nav-number">18.1.</span> <span class="nav-text">举个栗子：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#第一部分：Include-Theme主题的设置"><span class="nav-number">19.</span> <span class="nav-text">第一部分：Include Theme主题的设置</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#第二部分：Include-内容布局的设置"><span class="nav-number">20.</span> <span class="nav-text">第二部分：Include 内容布局的设置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#第一种-：-直接-layout-后面设置布局的XML"><span class="nav-number">20.1.</span> <span class="nav-text">第一种 ： 直接@layout 后面设置布局的XML</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第二种：通过引入theme的item设置的layout属性"><span class="nav-number">20.2.</span> <span class="nav-text">第二种：通过引入theme的item设置的layout属性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Include标签下："><span class="nav-number">20.2.1.</span> <span class="nav-text">Include标签下：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#包裹Include标签的布局Theme（注意：这里不是Include设置的主题）："><span class="nav-number">20.2.2.</span> <span class="nav-text">包裹Include标签的布局Theme（注意：这里不是Include设置的主题）：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第三部分：-Include标签的View处理"><span class="nav-number">20.3.</span> <span class="nav-text">第三部分： Include标签的View处理</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#流程图-3"><span class="nav-number">21.</span> <span class="nav-text">流程图</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#效果"><span class="nav-number">22.</span> <span class="nav-text">效果</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#分析"><span class="nav-number">23.</span> <span class="nav-text">分析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#实现思路"><span class="nav-number">24.</span> <span class="nav-text">实现思路</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#优缺点分析"><span class="nav-number">25.</span> <span class="nav-text">优缺点分析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#自定义Factory还是Factory2-？"><span class="nav-number">26.</span> <span class="nav-text">自定义Factory还是Factory2 ？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#注意事项"><span class="nav-number">27.</span> <span class="nav-text">注意事项</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#设置Factory但是发现无响应，是因为本身LayoutInflater中存在Factory2"><span class="nav-number">27.1.</span> <span class="nav-text">设置Factory但是发现无响应，是因为本身LayoutInflater中存在Factory2**</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用AppCompatActivity直接setFactory2或者setFactory为什么报错？"><span class="nav-number">27.2.</span> <span class="nav-text">使用AppCompatActivity直接setFactory2或者setFactory为什么报错？</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#自定义Factory2的实现-——-gt-CustomAppFactory"><span class="nav-number">28.</span> <span class="nav-text">自定义Factory2的实现 ——> CustomAppFactory</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#使用方式"><span class="nav-number">28.1.</span> <span class="nav-text">使用方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自定义过程"><span class="nav-number">28.2.</span> <span class="nav-text">自定义过程</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#onCreateView第一部分内容"><span class="nav-number">29.</span> <span class="nav-text">onCreateView第一部分内容</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#onCreateView第二部分内容"><span class="nav-number">30.</span> <span class="nav-text">onCreateView第二部分内容</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#处理ViewPager的滑动"><span class="nav-number">31.</span> <span class="nav-text">处理ViewPager的滑动</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">MagicalRice</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      本站访客数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人次
    </span>
  

  
    <span class="site-pv">
      本站总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>


        
      </div>
    </footer>

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>





  

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  


  <script type="text/javascript" src="/js/src/particle.js" count="50" zindex="-2" opacity="1" color="0,104,183"></script>
</body>
</html>
